---
title: "Results for document"
author: "Yuki Kanamori"
date: "2022/6/21"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
require(xlsx)
require(openxlsx)
require(readxl)
require(tidyverse)
require(investr)
require(abind)
require(gridExtra)
require(ggrepel)
require(cowplot)
require(maps)
require(mapdata)
require(scales)


dir = "/Users/Yuki/Dropbox/業務/キチジ太平洋北部/SA2022/inputdata/"
fileEncoding = "CP932"

# not change
knitr::opts_chunk$set(echo = TRUE)
n_year = 2022
options(warn = -1)
```

<!-- 
チャンクの構成はREADMEを参照
 -->



```{r prefecture, echo=F, message=FALSE, results='hide', warning=F, include=F}
#========== 表1と図5の作成，および資源量推定で必要な総漁獲量の算出 ==========#
# step1. 県から提出された漁獲量データ（沖底以外）を集計する
#        !!県から提出されたデータの構造に合わせてコードの修正が必要!!
#        県が提出する「沖底」の漁獲量 ≠ 沖底漁績の値，なので，step2で修正する
# 
#        
# step2. 漁獲量データを集計する
# step2-0. 昨年度の図5のデータ&最新版の沖底漁績データの読み込み
# step2-1. 沖底漁績の確定値をstep.2-0に入れる
# step2-2. 沖底漁績の暫定値をstep.1の県データに入れる
#          県が提出する「沖底」の漁獲量 ≠ 沖底漁績の値，に注意
# step2-3. 図5に必要なデータの統合
# step2-4. 表1のデータを作成
#          
# 
# step3. 作図
#===============================================#

# step1 ---------------------------------------------------------
#=== Aomori ===#
ao = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "ao") %>% select(漁法, 数量kg) %>% dplyr::rename(method = 漁法, catch_kg = 数量kg)
summary(ao)

# 県が提出した漁業種類ごとに漁獲量を集計
ao_sum = ao %>% dplyr::group_by(method) %>% dplyr::summarize(sum_temp = sum(catch_kg)) # kg

# 資源評価表の表1に合わせて「沖底，小底，刺網，延縄，定置，その他」の6つのカテゴリーに変更する
ao_sum$method
ao_sum$method2 = c("その他", "その他", "沖底", "小底") # ↑の情報を確認して，漁業種類を定義する

# 「沖底，小底，その他」ごとの漁獲量を集計
ao_sum = ao_sum %>% select(-method) %>% dplyr::group_by(method2) %>% dplyr::summarize(sum = sum(sum_temp))



#=== Iwate ===#
iwa = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "iwa") %>% select(漁業種名, "合計") %>% dplyr::rename(method = 漁業種名, sum_temp = 合計) %>% dplyr::group_by(method) %>% dplyr::summarize(sum_temp = sum(sum_temp))
iwa_sum = iwa

# 資源評価表の表1に合わせて「沖底，小底，刺網，延縄，定置，その他」の6つのカテゴリーに変更する
iwa_sum$method
iwa_sum$method2 = c("延縄", "沖底", "延縄") # ↑の情報を確認して，漁業種類を定義する

# 「沖底，小底，その他」ごとの漁獲量を集計
iwa_sum = iwa_sum %>% select(-method) %>% dplyr::group_by(method2) %>% dplyr::summarize(sum = sum(sum_temp))



#=== Miyagi ===#
miya = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "miya", startRow = 4)
miya = miya[, c(1,2,ncol(miya))]

# 県が提出した漁業種類ごとに漁獲量を集計
miya_l = miya %>% 
  filter(魚種コード == "きちじ") %>% 
  select(漁業種コード, 総計) %>% 
  dplyr::rename(method = 漁業種コード, sum = 総計)
miya_s = miya %>% 
  filter(魚種コード == "こきちじ") %>% 
  select(漁業種コード, 総計) %>% 
  dplyr::rename(method = 漁業種コード, sum = 総計)
miya2 = left_join(miya_l, miya_s, by = "method")
miya2[is.na(miya2)] = 0
miya2 = miya2 %>% mutate(sum_temp = sum.x+sum.y) %>% select(method, sum_temp)

# 資源評価表の表1に合わせて「沖底，小底，刺網，延縄，定置，その他」の6つのカテゴリーに変更する
miya2$method
miya2$method2 = c("沖底", "その他", "その他", "延縄") # ↑の情報を確認して，漁業種類を定義する
#沿岸小漁=その他

# 「沖底，小底，その他」ごとの漁獲量を集計
miya_sum = miya2 %>% select(-method) %>% dplyr::group_by(method2) %>% dplyr::summarize(sum = sum(sum_temp))



#=== Fukusima ===#
fuku = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "fuku", startRow = 2) %>% 
  select(沖合底びき網) %>% 
  mutate(method = paste0("沖合底びき網")) %>% 
  dplyr::rename(catch_kg = 沖合底びき網) %>% 
  na.omit %>% 
  dplyr::group_by(method) %>% 
  dplyr::summarize(sum = sum(catch_kg))
fuku_sum = fuku

# 資源評価表の表1に合わせて「沖底，小底，刺網，延縄，定置，その他」の6つのカテゴリーに変更する
fuku_sum$method
fuku_sum$method2 = c("沖底") # ↑の情報を確認して，漁業種類を定義する

fuku_sum = fuku_sum %>% select(-method)



#=== Ibaraki ===#
iba = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "iba", startRow = 4)
iba = iba[13, ] 

# 資源評価表の表1に合わせて「沖底，小底，刺網，延縄，定置，その他」の6つのカテゴリーに変更する
iba = iba %>% mutate(method2 = "沖底")

iba = iba[, 3:4]
colnames(iba)[1] = "sum"
iba_sum = iba



#=== 全県のデータを統合する ===#
# head(ao_sum); head(iwa_sum); head(miya_sum); head(fuku_sum); head(iba_sum)

merge = ao_sum %>% 
  dplyr::full_join(iwa_sum, by = "method2") %>% 
  dplyr::full_join(miya_sum, by = "method2") %>% 
  dplyr::full_join(fuku_sum, by = "method2") %>% 
  dplyr::full_join(iba_sum, by = "method2")


colnames(merge) = c("漁業種", "青森", "岩手", "宮城", "福島", "茨城")
merge[is.na(merge)] = 0
merge = merge %>% filter(漁業種 != "沖底") # 表1と図5の沖底は沖底漁績の値を使うため，県が提出した沖底の値は抜く




# step2 ---------------------------------------------------------
#=== step2-0 ===#
catch_old = read.csv(paste0(dir, "rawdata_fig5_for_nextSA.csv"), fileEncoding = fileEncoding) # 昨年の資源評価で作成したfig.5の元データ

sheets = excel_sheets(paste0(dir, "okisoko_after2019.xlsx")) #シート名の取得
new_okisoko = NULL
for(i in 1:length(sheets)){
  okisoko = read.xlsx(paste0(dir, "/okisoko_after2019.xlsx"), sheet = sheets[i]) %>% filter(漁区名 != "襟裳西")
  temp = data.frame(catch = sum(okisoko$漁獲量の合計)/1000, year = as.numeric(paste0(sheets[i])))
  new_okisoko = rbind(new_okisoko, temp)
} # 2019年~以降の沖底データ


#=== step2-1 ===#
# 沖底漁績の値は確定までに1年かかるので，(沖底漁績の最新年-1)年のデータを確定値に修正
# e.g., 2022年度の資源評価の場合，沖底漁績の最新年 = 2021（暫定値）, (沖底漁績の最新年-1)年 = 2020（確定値）
catch_old2 = catch_old %>% filter(year != as.numeric(paste0(n_year-2))) 

catch_2yr = catch_old %>% filter(year == as.numeric(paste0(n_year-2)), method != "沖底") 
okisoko_2yr = data.frame(catch_kg = NA, year = as.numeric(paste0(n_year-2)), method = "沖底", sum = new_okisoko %>% filter(year == as.numeric(paste0((n_year-2)))) %>% select(catch) %>% dplyr::rename(catch_t = catch)) %>% select(-catch_kg)
catch_2yr = rbind(catch_2yr, okisoko_2yr)

# catch_2yr = catch_2yr %>% mutate(catch_t = ifelse(catch_2yr$method == "沖底", new_okisoko %>% filter(year == as.numeric(n_year-2)) %>% select(catch), catch_2yr$catch_t))



#=== step2-2 ===#
# 県からもらった昨年度の漁獲量データの沖底の値を沖底漁績の暫定値に置換
catch_new = rbind(ao_sum, iwa_sum, miya_sum, fuku_sum, iba_sum) %>% mutate(年 = as.numeric(paste0(n_year-1)))

# 資源評価表の図5に合わせて「沖底，小底，沖底・小底以外」の3つのカテゴリーに変更する
catch_new = catch_new %>% mutate(method = ifelse(str_detect(catch_new$method2, pattern = "沖底"), "沖底", ifelse(str_detect(catch_new$method2, pattern = "小底"), "小底", "沖底・小底以外"))) %>% select(-method2) %>% dplyr::rename(year = 年) %>% dplyr::rename(catch_kg = sum) %>% mutate(sum = catch_kg/1000) 
total_catch_pref = catch_new %>% filter(method != "沖底") # 図5の沖底は沖底漁績の値を使うため，県が提出した沖底の値は抜く
total_catch_pref = total_catch_pref %>% dplyr::group_by(year, method) %>% dplyr::summarize(catch_t = sum(sum))


okisoko_1yr = data.frame(catch_kg = NA, year = as.numeric(paste0(n_year-1)), method = "沖底", sum = new_okisoko %>% filter(year == as.numeric(paste0((n_year-1)))) %>% select(catch) %>% dplyr::rename(catch_t = catch)) %>% select(-catch_kg)

catch_1yr = rbind(total_catch_pref, okisoko_1yr)



#=== step2-3 ===#
# データの統合
head(catch_old2); head(catch_2yr); head(catch_1yr)
summary(catch_old2); summary(catch_2yr); summary(catch_1yr)

catch = rbind(catch_old2, catch_2yr, catch_1yr)
summary(catch)
unique(catch$method)
levels(catch$method) 
catch$method = factor(catch$method, levels = c("沖底・小底以外", "小底", "沖底")) 



#=== step2-4 ===#
# 表1の作成
table1 = rbind(ao_sum, iwa_sum, miya_sum, fuku_sum, iba_sum) %>% mutate(年 = as.numeric(paste0(n_year-1))) %>% dplyr::group_by(method2) %>% dplyr::summarize(catch_t = sum(sum)/1000) %>% mutate(year = as.numeric(paste0(n_year-1))) %>% dplyr::rename(method = method2)
table1_t = table1 %>% dplyr::group_by(year) %>% dplyr::summarize(catch_t = sum(catch_t)) %>% dplyr::mutate(method = "total")
table1 = rbind(table1, table1_t)
table1 = rbind(table1 %>% filter(method != "沖底") %>% mutate(memo = ""), okisoko_1yr %>% mutate(memo = "暫定値"), okisoko_2yr %>% mutate(memo = "確定値．表の修正が必要")) 



# step3 ---------------------------------------------------------
g = ggplot(catch, aes(x = year, y = catch_t, fill = method))
b = geom_bar(stat = "identity", width = 0.5, colour = "black")
lab = labs(x = "年", y = "漁獲量 (トン)", fill = "漁業種")
col_catch = c("#FFF100", "white", "grey0")
c = scale_fill_manual(values = col_catch)
th = theme(aspect.ratio = 6.88/11.49,
           panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = 8, colour = "black"),
           axis.text.y = element_text(size = 8, colour = "black"),
           axis.text = element_text(family = "Arial", color = "black"),
           axis.title.x = element_text(size = 11),
           axis.title.y = element_text(size = 11),
           axis.ticks = element_line(size = 0.15, colour = "black"),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(0.8)),
           strip.text.x = element_text(size = rel(0.8)),
           legend.position = c(0.75, 0.7),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
fig5 = g+b+lab+c+theme_bw(base_family = "HiraginoSans-W3")+th+scale_x_continuous(expand = c(0,0), breaks=seq(1975, 2020, by = 5))+scale_y_continuous(expand = expansion(mult = c(0, 0)),limits = c(0, 4000), labels = label_comma())

catch2 = catch %>% dplyr::group_by(year) %>% dplyr::summarize(total_catch_t = sum(catch_t))
```





```{r get biomass and N, echo=FALSE, warning=FALSE, message=FALSE, results='hide', include=F}
#========== 1月時点の資源量を計算 ==========#
# step1. Number at ageデータの作成
# step1-1. Age-Length Keyの作成
# step1-2. von Bertalanffy growth curveの推定
# step1-3. 年齢別体長別の尾数データの算出（これは資源評価結果ではない）
# step1-4. 年齢別の平均体長と平均重量を算出
# 
# step2. 年齢別の生存率を算出（翌年の資源量計算で，ここで出てくる1歳魚->2歳魚の生残率を使う．3歳魚以上はstep6で出てくる生残率を使う）
# 
# step3. 体長別の採集効率(q)を考える
#        
# step4. 体長から体重を算出
#        
# step5. 採集効率が年齢で変わることを考慮して10月（調査時）の資源量と資源尾数を算出
#
# step6. 採集効率を考慮した資源尾数から生残率を算出（3歳魚以上の部分を，翌年の資源量計算で使う -> see チャンクABC）
#        
# step7. 1月時点での資源量を算出するため，調査が行われた10月以降の2ヶ月分の漁獲率や自然死亡率などを仮定する
#        
# step8. 10月の調査データから1月の資源量を算出
#        
# step9. 漁獲割合
#        
# step10. figures; figs. 10-12
#===============================================#


# step1. Number at ageの作成 ---------------------------------------------------------
#=== -2018年までのデータ ===# 
# 資源評価で使用されていたデータをそのまま使う
olddata = read.csv(paste0(dir, "olddata_trawl.csv")) 
old_trawl = olddata %>% filter(data == 'trawl') %>% gather(key = year_tag, value = number, 2:(ncol(olddata)-1)) %>% mutate(year = as.numeric(str_sub(year_tag, 2, 5))) %>% select(-year_tag, -data)
summary(old_trawl)


#=== 2019年以降のデータ ===#
# 年齢査定データからALKを作成して年齢別データに分解していく
sheets = excel_sheets(paste0(dir, "ALdata.xlsx")) #シート名の取得

number_at_age_table = NULL
mean_length_weight_at_age_table = NULL
for(i in 1:length(sheets)){
  df = read.xlsx(paste0(dir, "ALdata.xlsx"), sheet = sheets[i]) %>% filter(pick == 1) %>% select(label, SL, age)
  summary(df)
  mode(df$age)
  
  # step1-1. Age Length Keyの作成 --------------------
  # 年齢査定結果が10+以上と?の個体を除去（characterをnumericにするので，10+と?はNAになる）
  df = df %>% mutate(length_mm = SL, age_num = as.numeric(as.character(age))) # NAの発生は問題ない
  df2 = na.omit(df)
  
  # step1-2. fit the von Bertalanffy growth curveの推定 --------
  # Lt = L_max*(1-e^(-K(t-t0)))
  mode(df2$age_num)
  mode(df2$length_mm)
  #Lmax = 320
  fit = nls(length_mm ~ 320*(1-exp(-K*((age_num+0.5) - t0))), data = df2, start = c(K = 0.01, t0 = -3), trace = TRUE)
  fit2 = summary(fit)
  
  
  # step1-3. 年齢別体長別の尾数データの算出 --------
  # 年齢査定を行った個体は体長を測定しているので，各体長クラスごとに年齢の頻度（AC）を算出する
  # その後，ACを調査で得た体長データ（年齢査定していないもの．南北の海域ごとに海底面積で引き延ばされたもの）に掛けて，年齢別体長別尾数を算出する
  
  # 年齢別体長別の尾数（年齢査定をした個体のみ）
  # !!note!!  use 10+ and 10++
  df3 = df %>% select(SL, age) %>% dplyr::rename(length_mm = SL)
  df3 = df3 %>% mutate(fumei = ifelse(df3$age == "?", 100, as.character(df3$age)))
  df3 = df3 %>% mutate(fumei = ifelse(df3$age == "?", 100, as.character(df3$age)),
                       age2 = ifelse(df3$age == "10+", 10, ifelse(df3$age > 9, 10, as.character(df3$age)))) %>% filter(fumei != 100) %>% select(-fumei) %>% mutate(count = 1)
  df3$age2 = as.numeric(df3$age2)
  df3$age3 = ifelse(df3$age2 > 10, 10, df3$age2)
  df3 = na.omit(df3)
  naa = df3 %>% dplyr::group_by(length_mm, age3) %>% dplyr::summarize(number = sum(count))

  length_mm = rep(seq(min(df3$length_mm), max(df3$length_mm)), length(unique(df3$age3))+1)
  age_num = rep(0:max(df3$age3), each = length(unique(length_mm)))
  tag = data.frame(length_mm = length_mm, age_num = age_num)
  tag = tag %>% mutate(length_cate = ifelse(length_mm < 100, str_sub(tag$length_mm, 1, 1), str_sub(tag$length_mm, 1, 2)))
  tag = tag %>% dplyr::rename(age = age_num)
  
  naa2 = merge(naa %>% dplyr::rename(age = age3), tag, by = c("length_mm", "age"), all = T)
  naa2$number = ifelse(is.na(naa2$number), 0, naa2$number)
  summary(naa2)
  NAA = naa2 %>% dplyr::group_by(age, length_cate) %>% dplyr::summarize(number = sum(number))
  NAA$length_cate = as.numeric(NAA$length_cate)
  summary(NAA)
  
  add = data.frame(length_cate = rep(1:(min(NAA$length_cate)-1), each = length(unique(NAA$age))), age = unique(NAA$age), number = 0)
  NAA = rbind(add, NAA)
  NAA = NAA %>% arrange(length_cate, age) 
  sum = NAA %>% dplyr::group_by(length_cate) %>% dplyr::summarize(sum = sum(number)) %>% mutate(age = 11) %>% dplyr::rename(number = sum)
  number_at_age = rbind(NAA, sum) %>% tidyr::spread(key = length_cate, value = number)
  number_at_age$age = as.character(number_at_age$age) # 年齢別体長別尾数（年齢査定をした個体）
  number_at_age[12, 1] = "total"
  #write.csv(number_at_age, "number_at_age.csv", fileEncoding = fileEncoding)
  
  
  # 年齢別体長別の頻度
  AC = left_join(NAA, sum %>% select(-age) %>% dplyr::rename(sum = number), by = "length_cate") %>% mutate(freq = ifelse(sum > 0, number/sum, 0))
  AC = AC %>% select(length_cate, age, freq)
  a_sum = AC %>% dplyr::group_by(length_cate) %>% dplyr::summarize(sum = sum(freq)) %>% mutate(age = 11) %>% dplyr::rename(freq = sum)
  age_composition = rbind(AC, a_sum) %>% tidyr::spread(key = length_cate, value = freq)
  age_composition$age = as.character(age_composition$age) # 年齢別体長別の頻度
  age_composition[12, 1] = "total"
  
  
  # 調査で得られた尾数データ（パンチデータ．海域面積で引き延ばされている）
  len_num = read.csv(paste0(dir, "survey_N_at_length.csv"), fileEncoding = fileEncoding) %>% mutate(year = as.numeric(str_sub(調査種類名称, 1, 4))) %>% filter(year == sheets[i]) %>% select(-year)
  len_num = len_num[, 16:ncol(len_num)] %>% mutate(site = c("N", "S"))
  len_num = len_num %>% gather(key = age_j, value = number, 1:(ncol(len_num)-1)) %>% na.omit()
  len_num2 = len_num %>% dplyr::group_by(age_j) %>% dplyr::summarize(number = sum(number)) %>% mutate(length_cate = as.numeric(str_sub(age_j, 3, 4))) %>% select(-age_j)
  
  
  # 年齢別体長別の頻度データ（AC）× 調査で得られた尾数データ = 年齢別体長別の尾数
  AC2 = left_join(AC, len_num2, by = "length_cate") %>% mutate(bisu = freq*number)
  if(length(unique(AC2$length_cate)) < 30){
    add = data.frame(length_cate = 30, age = rep(0:10), freq = 0, number = 0, bisu = 0)
    AC2 = rbind(AC2, add)
  }
  num_ac2 = AC2 %>% dplyr::group_by(length_cate) %>% dplyr::summarize(total = mean(number)) %>% mutate(age = 11) %>% dplyr::rename(bisu = total)
  number_at_age2 = rbind(AC2 %>% select(age, length_cate, bisu), num_ac2) %>% tidyr::spread(key = length_cate, value = bisu)
  number_at_age2$age = as.character(number_at_age2$age)
  number_at_age2[12, 1] = "total"
  # write.csv(number_at_age2, "number_at_age_exp.csv")
  
  
  # step1-4. 年齢別の平均体長と平均重量を算出 -----------------------
  # 重量はここではいらんかも．将来的に削除
  number_at_age3 = number_at_age2[-nrow(number_at_age2), ] %>% gather(key = length, value = number, 2:ncol(number_at_age2))
  number_at_age3 = number_at_age2 %>% gather(key = length, value = number, 2:ncol(number_at_age2)) %>% filter(age != "total")
  length = number_at_age3 %>% mutate(sum_length = (as.numeric(as.character(as.factor(length))) + 0.5)*number)
  
  s_length_age = length %>% dplyr::group_by(age) %>% dplyr::summarize(sum_l = sum(sum_length))
  s_number_age = length %>% dplyr::group_by(age) %>% dplyr::summarize(sum_n = sum(number))

  mean_length_weight_at_age = left_join(s_length_age, s_number_age, by = "age") %>% mutate(mean_cm = sum_l/sum_n) %>% select(age, mean_cm) %>% mutate(mean_mm = mean_cm*10) %>% mutate(weight = (1.86739*10^(-5))*(mean_mm^3.06825547)) 
  # write.csv(mean_length_weight_at_age, "mean_length_weight_at_age.csv")
  
  #output
  mean_length_weight_at_age$year = as.numeric(paste0(sheets[i]))
  number_at_age2$year = as.numeric(paste0(sheets[i]))
  mean_length_weight_at_age_table = rbind(mean_length_weight_at_age_table, mean_length_weight_at_age)
  number_at_age_table = rbind(number_at_age_table, number_at_age2)
}


# 2018年以前と2019年以降のデータを統合
# 年齢別体長別の尾数（1995~のデータがオブジェクトtrawlにまとまる）
temp = NULL
for(i in min(number_at_age_table$year):max(number_at_age_table$year)){
  naa = number_at_age_table %>% filter(year == i)
  naa = naa[1:(nrow(naa)-1), 3:ncol(naa)]
  naa = apply(naa, 1, sum)
  naa = naa %>% data.frame() %>% mutate(age = 0:10) %>% filter(age != 0)
  colnames(naa) = c('number', 'age')
  naa$year = as.numeric(paste0(i))
  temp = rbind(temp, naa)
}
trawl = rbind(old_trawl, temp)
summary(trawl)


# 年齢別の平均体長（1995~のデータがオブジェクトlengthにまとまる）
old_length = olddata %>% filter(data == 'length') %>% gather(key = year_tag, value = mean_mm, 2:(ncol(olddata)-1)) %>% mutate(year = as.numeric(str_sub(year_tag, 2, 5))) %>% select(-year_tag, -data)
summary(old_length)
temp_length = NULL
for(i in 1:length(sheets)){
  length = mean_length_weight_at_age_table %>% filter(year == sheets[i]) %>% select(age, mean_mm) %>% mutate(age = as.numeric(age), year = as.numeric(paste0(sheets[i]))) %>% filter(age > 1)
  length2 = rbind(length[2:nrow(length),], length[1, ]) # ageが数値なので10->2->3...となっているのを直す
  temp_length = rbind(temp_length, length2)
}
length = rbind(old_length, temp_length)
summary(length)
tableA4_2 = length # 補足表4-2


# 調査開始（1995年）以降の漁獲量
catchF = catch2 %>% filter(year > 1994) %>% dplyr::rename(catch = total_catch_t)



# step2. 年齢別の生残率を算出（t年のi歳の尾数/t+1年のi+1歳の尾数） ---------------------------------------------------------
# 1歳魚->2歳魚の生残率を翌年の資源量計算で使用する．3歳魚以上の生残率はstep6の値を使用する
survival1 = NULL
for(i in min(trawl$year):(max(trawl$year)-1)){
  # i = min(trawl$year)
  data_lastyr = trawl %>% filter(year == i)
  data_thisyr = trawl %>% filter(year == (i+1))
  data = left_join(data_lastyr, data_thisyr, by = 'age') %>% arrange(age)
  surv = matrix(NA, ncol = 1, nrow = 9)

  if(i < 2005){ # 2005年までは年齢査定は5歳まで
    for(j in 2:5){
      if(j < 5){
        surv[(j-1), 1] = data$number.y[(j)]/data$number.x[(j-1)]
      }else{
        surv[(j-1), 1] = data$number.y[(j)]/(data$number.x[j]+data$number.x[j-1])
      }
    }
  }

  if(i == 2005){
    for(j in 2:5){
      if(j < 5){
        surv[(j-1), 1] = data$number.y[(j)]/data$number.x[(j-1)]
      }else{
        surv[(j-1), 1] = (data$number.y[(j)]+data$number.y[(j+1)]+data$number.y[(j+2)]+data$number.y[(j+3)]+data$number.y[(j+4)]+data$number.y[(j+5)])/(data$number.x[j]+data$number.x[j-1])
      }
    }
  }

  if(i > 2005){
    for(j in 2:10){
      if(j < 10){
        surv[(j-1), 1] = data$number.y[(j)]/data$number.x[(j-1)]
      }else{
        surv[(j-1), 1] = data$number.y[(j)]/(data$number.x[j]+data$number.x[j-1])
      }
    }
  }
  survival1 = rbind(survival1, surv)
}
survival1 = data.frame(surv = survival1, year = rep((min(trawl$year)+1):(max(trawl$year)), each = 9), age = rep(2:10))



# step3. 体長別の採集効率(q)を考える ---------------------------------------------------------
a = 1524.58141594268 # fixed
b = 0.0823656986637998 # fixed
c = 0.738106676282726 # fixed
# ↑エクセルの値をそのまま張り付け

q = NULL
for(i in min(length$year):max(length$year)){
  # i = max(length$year)-1
  data = length %>% filter(year == i) %>% arrange(age)
  temp_q = matrix(NA, ncol = 1, nrow = 9)
  
  for(j in 1:9){
    temp_q[j, 1] = c/{1+a*exp(-b*data$mean_mm[j])}
  }
  temp_q2 = data.frame(q = temp_q[,1], year = mean(data$year), age = 2:10)
  q = rbind(q, temp_q2)
}  
summary(q)



# step4. 体長から体重を算出 ---------------------------------------------------------
weight = NULL
for(i in min(length$year):max(length$year)){
  # i = min(length$year)
  data = length %>% filter(year == i) %>% arrange(age)
  temp_w = matrix(NA, ncol = 1, nrow = 9)
  
  for(j in 1:9){
    temp_w[j, 1] = (1.86739*10^(-5))*data$mean_mm[j]^(3.06825547)
  }
  temp_w2 = data.frame(weight = temp_w[,1], year = mean(data$year), age = 2:10)
  weight = rbind(weight, temp_w2)
}
summary(weight)
tableA4_3 = weight # 補足表4-3


# step5. 採集効率が年齢で変わることを考慮して10月（調査時）の資源量と資源尾数を算出 ---------------------------------------------------------
abund_oct_sel = NULL
for(i in min(trawl$year):max(trawl$year)){
  # i = min(trawl$year)
  data_trawl = trawl %>% filter(year == i)
  data_q = q %>% filter(year == i)
  data_weight = weight %>% filter(year == i)
  data = left_join(data_trawl, data_q, by = c("age", "year")) %>% filter(age > 1) %>% arrange(age)
  data = left_join(data, data_weight,  by = c("age", "year")) %>% filter(age > 1) %>% arrange(age)
  
  temp_naa_sel = matrix(NA, ncol = 1, nrow = 9)
  temp_baa_sel = matrix(NA, ncol = 1, nrow = 9)
  
  for(j in 1:9){
    #j = 9
    temp_naa_sel[j, 1] = data$number[j]/data$q[j]
  }
  
  for(k in 1:9){
    temp_baa_sel[k, 1] = temp_naa_sel[k, 1]*data$weight[k]*(0.001)^2
  }
  
  temp_abund_oct = data.frame(number_sel = temp_naa_sel[, 1], biomass_sel = temp_baa_sel[, 1], year = mean(data$year), age = 2:10)
  abund_oct_sel = rbind(abund_oct_sel, temp_abund_oct)
}



# step6. 年齢別の生残率を算出（t年のi歳の尾数/t+1年のi+1歳の尾数）  -------------------------------------------------------
# 3歳魚以上の生残率を翌年の資源量計算で使用する
survival = NULL
for(i in min(abund_oct_sel$year):(max(abund_oct_sel$year)-1)){
  # i = min(trawl$year)
  data_lastyr = abund_oct_sel %>% filter(year == i)
  data_thisyr = abund_oct_sel %>% filter(year == (i+1))
  data = left_join(data_lastyr, data_thisyr, by = 'age') %>% arrange(age)
  surv = matrix(NA, ncol = 1, nrow = 9)
  
  if(i < 2005){ # 2005年までは年齢査定は5歳まで
    for(j in 1:4){
      if(j < 3){
        surv[j, 1] = data$number_sel.y[(j+1)]/data$number_sel.x[(j)]
      }else{
        surv[j, 1] = data$number_sel.y[(j+1)]/(data$number_sel.x[j]+data$number_sel.x[j+1])
      }
    }
  }
  
  if(i == 2005){
    for(j in 1:4){
      if(j < 3){
        surv[j, 1] = data$number_sel.y[(j+1)]/data$number_sel.x[j]
      }else{
        surv[j, 1] = (data$number_sel.y[(j+1)]+data$number_sel.y[(j+2)]+data$number_sel.y[(j+3)]+data$number_sel.y[(j+4)]+data$number_sel.y[(j+5)]+data$number_sel.y[(j+6)])/(data$number_sel.x[j]+data$number_sel.x[j+1])
      }
    }
  }
  
  if(i > 2005){
    for(j in 1:8){
      if(j < 8){
        surv[j, 1] = data$number_sel.y[(j+1)]/data$number_sel.x[j]
      }else{
        surv[j, 1] = data$number_sel.y[(j+1)]/(data$number_sel.x[j]+data$number_sel.x[j+1])
      }
    }
  }
  survival = rbind(survival, surv)
}
survival = data.frame(surv = survival, year = rep((min(abund_oct_sel$year)+1):(max(abund_oct_sel$year)), each = 9), age = rep(2:10))



# step7. 1月時点での資源量を算出するため，調査が行われた10月以降の2ヶ月分の漁獲率や自然死亡率などを仮定する ---------------------------------------------------------
M = 2.5/20 #fixed

abund_jan_forF_notneeded = NULL
fishing_rate = NULL
Z = NULL
survival_2month = NULL
for(i in (min(abund_oct_sel$year)+1):max(abund_oct_sel$year)){
  # i = min(abund_oct_sel$year)+1
  data_oct_sel_last = abund_oct_sel %>% filter(year == (i-1)) %>% na.omit()
  data_catchF_last = catchF %>% filter(year == (i-1))
  data_catchF_this = catchF %>% filter(year == i)
  
  temp_abund_jan = sum(data_oct_sel_last$biomass_sel)*exp(-2/12*0.125)-data_catchF_last$catch/6*exp(-2/12*0.125) # 値
  temp_fishing_rate = data_catchF_this$catch/temp_abund_jan
  temp_f = -log(1-(temp_fishing_rate/exp(-M/2)))
  temp_Z = temp_f + M
  temp_survival_2month = exp(-temp_Z/6)
  
  abund_jan_forF_notneeded_pre = data.frame(biomass = temp_abund_jan, year = i)
  fishing_rate_pre = data.frame(f = temp_fishing_rate, year = i)
  Z_pre = data.frame(z = temp_Z, year = i)
  survival_2month_pre = data.frame(surv = temp_survival_2month, year = i)
  
  abund_jan_forF_notneeded = rbind(abund_jan_forF_notneeded, abund_jan_forF_notneeded_pre)
  fishing_rate = rbind(fishing_rate, fishing_rate_pre)
  Z = rbind(Z, Z_pre)
  survival_2month = rbind(survival_2month, survival_2month_pre)
}



# step8. 10月の調査データから1月の資源量を算出 ---------------------------------------------------------
est = NULL
for(i in (min(abund_oct_sel$year)+1):(max(abund_oct_sel$year)+1)){
  # i = max(abund_oct_sel$year) #1995
  
  if(i < max(abund_oct_sel$year)+1){
    data_survival = survival_2month %>% filter(year == i)
    data_abund_oct_sel = abund_oct_sel %>% filter(year == (i-1)) %>% arrange(age)
    data_weight = weight %>% filter(year == (i-1)) %>% arrange(age)
    
    temp_number = matrix(NA, ncol = 1, nrow = nrow(data_abund_oct_sel))
    temp_biomass = matrix(NA, ncol = 1, nrow = nrow(data_abund_oct_sel))
    
    for(j in 1:nrow(data_abund_oct_sel)){
      temp_number[j, 1] = data_survival$surv*data_abund_oct_sel$number_sel[j]
    }
    
    for(k in 1:nrow(data_abund_oct_sel)){
      temp_biomass[k, 1] = temp_number[k, 1]*data_weight$weight[k]*(0.001)^2
    }
    
    temp_est = data.frame(number = temp_number[, 1], biomass = temp_biomass[, 1], year = i, age = 2:10)
    est = rbind(est, temp_est)
  }
  
  if(i == max(abund_oct_sel$year)+1){
    data_survival = survival_2month %>% filter(year == (i-1))
    data_abund_oct_sel = abund_oct_sel %>% filter(year == (i-1)) %>% arrange(age)
    data_weight = weight %>% filter(year == (i-1)) %>% arrange(age)
    
    temp_number = matrix(NA, ncol = 1, nrow = nrow(data_abund_oct_sel))
    temp_biomass = matrix(NA, ncol = 1, nrow = nrow(data_abund_oct_sel))
    
    for(j in 1:nrow(data_abund_oct_sel)){
      temp_number[j, 1] = data_survival$surv*data_abund_oct_sel$number_sel[j]
    }
    
    for(k in 1:nrow(data_abund_oct_sel)){
      temp_biomass[k, 1] = temp_number[k, 1]*data_weight$weight[k]*(0.001)^2
    }
    
    temp_est = data.frame(number = temp_number[, 1], biomass = temp_biomass[, 1], year = i, age = 2:10)
    est = rbind(est, temp_est)
  }
}



# step9. 漁獲割合 ---------------------------------------------------------
trend = est %>% select(year, biomass) %>% na.omit() %>% dplyr::group_by(year) %>% dplyr::summarize(total = sum(biomass))
catch_rate = left_join(catchF, trend, by = "year") %>% mutate(rate = catch/total*100) %>% mutate(temp = (rate/100/exp(-M/2))) %>% mutate(temp2 = 1-temp) %>% mutate(F = -log(temp2))
fishing_trend = catch_rate %>% select(year, rate, F) %>% gather(key = data, value = value, -year) %>% mutate(data2 = ifelse(data == "F", "F値", "漁獲割合"))

# mean = fishing_trend %>% filter(data == "rate") %>% filter(year > ((as.numeric(str_sub(Sys.Date(), 1, 4))-1)-3)) %>% select(value)
# (mean_fishing_trend = mean(mean$value))



# step10. figures ---------------------------------------------------------
### 資源量の年トレンド (fig. 10)
trend = est %>% select(year, biomass) %>% na.omit() %>% dplyr::group_by(year) %>% dplyr::summarize(total = sum(biomass))
low = (max(trend$total)-min(trend$total))*1/3+min(trend$total)
high = max(trend$total)-(max(trend$total)-min(trend$total))*1/3
g = ggplot(trend, aes(x = year, y = total/1000))
p = geom_point(shape = 20, size = 3)
l = geom_line(size = 0.6, linetype = "solid")
lab = labs(x = "年", y = "資源量（千トン）", shape = "")
th = theme(aspect.ratio = 6.88/11.49,
           panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = 8, colour = "black"),
           axis.text.y = element_text(size = 8, colour = "black"),
           axis.text = element_text(family = "Arial", color = "black"),
           axis.title.x = element_text(size = 11),
           axis.title.y = element_text(size = 11),
           axis.ticks = element_line(size = 0.15, colour = "black"),
           legend.title = element_text(size = 11),
           strip.text.x = element_text(size = 11))
level_l = geom_hline(yintercept = low/1000, linetype = "dashed", color = "gray50")
level_h = geom_hline(yintercept = high/1000, linetype = "dashed", color = "gray50")
fig10 = g+p+l+lab+theme_bw(base_family = "HiraginoSans-W3")+ theme(legend.position = 'none')+th+theme(legend.position = 'none')+scale_x_continuous(breaks=seq(1996, 2021, by = 5), expand = c(0.03, 0.03))+scale_y_continuous(breaks=seq(0, 13, by = 5), expand = c(0,0),limits = c(0, 13))+level_l+level_h+annotate("text",label="高位", x = 1997, y = 12, family="HiraKakuPro-W3", size = 4)+annotate("text",label="中位", x = 1997, y = 7.8, family="HiraKakuPro-W3", size = 4)+annotate("text",label="低位", x = 1997, y = 4, family="HiraKakuPro-W3", size = 4)



### 資源尾数の年トレンド (fig. 11)
est = est %>% dplyr::mutate(age2 = ifelse(age > 4, "5歳以上", "2-4歳"))
summary(est)
N_trend = est %>% na.omit() %>% dplyr::group_by(year, age2) %>% dplyr::summarize(number = sum(number)/1000)
est2 = est
est2[is.na(est2)] = 0
est2 = est2 %>% dplyr::group_by(year, age2) %>% dplyr::summarize(total = sum(number))

summary(est2)
levels(est2$age2) 
unique(est$age2)
est2$age2 = factor(est2$age2, levels = c("5歳以上", "2-4歳"))
levels(est2$age2)
g = ggplot(est2, aes(x = year, y = total/1000000, fill = age2))
b = geom_bar(stat = "identity", width = 0.5, colour = "black")
lab = labs(x = "年", y = "資源尾数（百万尾）", legend = NULL)
col_age = c("black", "white")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
c = scale_fill_manual(values =  c("black", "white"))
fig11 = g+b+lab+c+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2022, by = 2), expand = c(0, 0.5))+scale_y_continuous(expand = c(0,0),limits = c(0, 150))



### 漁獲圧と漁獲割合の年トレンド (fig. 12)
# F values
g = ggplot(fishing_trend %>% filter(data == "F") %>% na.omit(), aes(x = year, y = value))
p = geom_point(size = 5)
l = geom_line(size = 1)
lab = labs(x = "", y = "F値")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
trend_f = g+l+p+lab+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2020, by = 2), expand = c(0, 0.5))

# catch rate
g = ggplot(fishing_trend %>% filter(data == "rate") %>% na.omit(), aes(x = year, y = value))
p = geom_point(size = 5)
l = geom_line(size = 1)
lab = labs(x = "年", y = "漁獲割合（%）")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
trend_catch_rate = g+l+p+lab+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2020, by = 2), expand = c(0, 0.5))
```





```{r get srr, echo=F, results=F, warning=F, include=F}
#========== 再生産関係の計算 ==========#
# step1. 調査で得られた資源尾数（南北海域別）
# 
# step2. 再生産関係（SRR）
# 
# step3. 作図; 図13と15
#===============================================#


# step1. 調査で得られた資源尾数（南北海域別） ---------------------------------------------------------
# 南北別漁獲量（調査）
ns = read.csv(paste0(dir, "trawl_N_at_length_ns.csv"), fileEncoding = fileEncoding)
summary(ns)
ns[is.na(ns)] = 0
ns = ns %>% dplyr::rename(year = 年, area = 南北) %>% gather(key = size_class, value = number, -c("year", "area"))
ns = ns %>% mutate(size_class = as.numeric(str_sub(ns$size_class, 2,3)))
summary(ns)

net_eff = data.frame(size = seq(15, 315, 10)) 
net_eff = net_eff %>% mutate(q = 0.738/(1+1525*exp(-0.0824*net_eff$size)), size_class = rep(1:nrow(net_eff)))
summary(net_eff)

ns = left_join(ns, net_eff, by = "size_class")
summary(ns)
ns = ns %>% mutate(number_sel = ns$number/ns$q)
ns = ns %>% dplyr::mutate(weight = 1.867*10^(-5)*ns$size^(3.068))
ns = ns %>% dplyr::mutate(biomass_sel = ns$number_sel*ns$weight)
ns3 = ns %>% dplyr::group_by(year, area) %>% dplyr::summarize(total_number = sum(number_sel), total_biomass = sum(biomass_sel))
ns4 = left_join(ns3 %>% select(-total_biomass) %>% spread(key = area, value = total_number), ns3 %>% select(-total_number) %>% spread(key = area, value = total_biomass), by = "year") 

ns4$n_rate_number = ns4$北部.x/(ns4$南部.x+ns4$北部.x)
ns4$n_rate_biomass = ns4$北部.y/(ns4$南部.y+ns4$北部.y)
ns4_2 = ns4 %>% mutate(year = year + 1)

head(trend)  
trend_ns = left_join(trend, ns4_2 %>% select(year, n_rate_biomass), by = "year")
trend_ns = trend_ns %>% mutate(total_n = (trend_ns$total)/1000*trend_ns$n_rate_biomass, total_s = (trend_ns$total)/1000*(1-trend_ns$n_rate_biomass)) %>% select(year, total_n, total_s) %>% gather(key = data, value = biomass_sel, -year) %>% mutate(area = rep(c("北部", "南部"), each = length(unique(trend_ns$year)))) %>% na.omit()

### fig. A3-3
levels(trend_ns$area)
trend_ns$area = factor(trend_ns$area, levels = c("北部", "南部"))
g = ggplot(trend_ns, aes(x = year, y = biomass_sel, fill = area))
b = geom_bar(stat = "identity", width = 0.5, colour = "black")
lab = labs(x = "年", y = "資源量（千トン）", legend = NULL)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
c = scale_fill_manual(values =  c("white", "black"))
fig_a33 = g+b+lab+c+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2020, by = 2), expand= c(0, 0.5))+scale_y_continuous(expand = c(0,0),limits = c(0, 15))



# step2. 再生産関係(SRR) ----------------------
# 親（メス）量は推定した資源量ではなく，調査で得られた尾数に採集効率を掛けて算出する
# 何でestを使わないのか不明だけど，lengthベースで成熟率や採集効率を計算するので，こちらの方が都合が良いのかな？
ns_rec = ns %>% dplyr::group_by(year, size_class, size) %>% dplyr::summarize(number = sum(number))

net_eff = data.frame(size = seq(15, 315, 10)) 
net_eff = net_eff %>% mutate(q = 0.738/(1+1525*exp(-0.0824*net_eff$size)), size_class = rep(1:nrow(net_eff)))

ns_rec = left_join(ns_rec, net_eff, by = c("size", "size_class"))
ns_rec = ns_rec %>% mutate(number_sel = number/q)

survival_2month2 = survival_2month %>% mutate(year = year-1)
survival_2month2_latest = abind(survival_2month2 %>% filter(year == as.numeric(str_sub(Sys.Date(), 1, 4))-2) %>% select(surv), as.numeric(str_sub(Sys.Date(), 1, 4))-1) %>% data.frame
survival_2month2 = abind(survival_2month2, survival_2month2_latest, along = 1) %>% data.frame() %>% dplyr::rename(year = V2)


ns_rec = left_join(ns_rec, survival_2month2, by = "year") 
ns_rec$weight = 1.867*10^(-5)*((ns_rec$size_class+0.5)*10)^(3.068)

ns_rec2 = ns_rec %>% mutate(number_sel2 = number_sel*surv, year2 = year+1, maturity = 100/(1+exp(-1.967*((size_class+0.5)-15.309)))) %>% mutate(number_adult = number_sel2*maturity*0.01) %>% mutate(biomass_adult = number_adult*weight)

# メス量
biomass_female = ns_rec2 %>% dplyr::group_by(year2) %>% dplyr::summarize(biomass = sum(biomass_adult)/2)
summary(est)

rec_number = est %>% select(number, year, age) %>% mutate(year2 = year-3) %>% filter(age == 2)
srr = left_join(biomass_female, rec_number, by = "year2")
srr = srr %>% mutate(rps = number/(biomass*0.001))



# step3. figures ----------------------
g = ggplot(srr %>% na.omit(),  aes(x = year2, y = rps))
b = geom_bar(stat = "identity", width = 0.5, colour = "black", fill = "black")
lab = labs(x = "年級", y = "RPS（尾/kg）", legend = NULL)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.5), colour = "black"),
           axis.text.y = element_text(size = rel(1.5), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(1.5)),
           strip.text.x = element_text(size = rel(1.5)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
fig13 = g+b+lab+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2020, by = 2), expand= c(0, 0.5))+scale_y_continuous(expand = c(0,0),limits = c(0, 60))


g = ggplot(srr %>% na.omit(), aes(x = year2, y = number/1000000))
p = geom_point(size = 5)
l = geom_line(size = 1)
lab = labs(x = "", y = "2歳魚尾数（百万尾）")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
ko = g+l+p+lab+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2018, by = 2), expand = c(0, 0.5))+scale_y_continuous(expand = c(0,0),limits = c(0, 100))


srr1 = srr %>% na.omit()
low = (max(srr1$biomass)-min(srr1$biomass))*1/3+min(srr1$biomass)
high = max(srr1$biomass)-(max(srr1$biomass)-min(srr1$biomass))*1/3
min(srr1$biomass)
max(srr1$biomass)

g = ggplot(srr1, aes(x = year2, y = biomass/1000000))
p = geom_point(size = 5)
l = geom_line(size = 1)
lab = labs(x = "年級", y = "雌親魚量（トン）")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
level_l = geom_hline(yintercept = low/1000000, linetype = "dashed", color = "gray50")
level_h = geom_hline(yintercept = high/1000000, linetype = "dashed", color = "gray50")
oya = g+l+p+lab+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2018, by = 2), expand = c(0, 0.5))+scale_y_continuous(expand = c(0,0),limits = c(0, 6000))


srr2 = srr %>% na.omit() %>% mutate(year3 = ifelse(year2 == 1996, 1996, ifelse(year2 == 2018, 2018, NA)))
g = ggplot(srr2, aes(x = biomass/1000000, y = number/1000000, label = year3))
p = geom_point(size = 3)
l = geom_line(size = 1)
pa = geom_path()
lab = labs(x = "雌親魚量（トン）", y = "2歳魚尾数（百万尾）")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = 8, colour = "black"),
           axis.text.y = element_text(size = 8, colour = "black"),
           axis.text = element_text(family = "Arial", color = "black"),
           axis.title.x = element_text(size = 11),
           axis.title.y = element_text(size = 11),
           axis.ticks = element_line(size = 0.15, colour = "black"),
           legend.title = element_blank(),
           strip.text.x = element_text(size = rel(0.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
fig15 = g+p+pa+lab+theme_bw(base_family = "HiraginoSans-W3")+th+scale_x_continuous(expand = c(0,0),limits = c(0, 5800), labels = label_comma())+scale_y_continuous(expand = c(0,0),limits = c(0, 100))+annotate("text", x = 300, y = 4, label = "1996", size = 4)+annotate("text", x = 5000, y = 8, label = "2018", size = 4)
```



```{r ABC, echo=F, results=F, warning=F, include=F}
# # F_current = 直近3年のFの平均
# F = catch_rate %>% mutate(temp = (rate/100/exp(-M/2))) %>% mutate(temp2 = 1-temp) %>% mutate(F = -log(temp2))
f_current = catch_rate %>% filter(year > (n_year-4)) %>% summarize(mean(F))

s_current = exp(-(M+f_current))

# 1歳魚の生残率
s1_current = survival1 %>% filter(year > (n_year-4), age == 2) %>% summarize(mean(surv))

# 1歳魚が2歳魚になる計算
number_2old_oct_last = trawl %>% filter(year == (n_year-1), age == 1) %>% select(number)/1000 * s1_current
number_2old_jan_this = number_2old_oct_last*survival_2month %>% filter(year == (n_year-1)) %>% select(surv)
number_2old_jan_this_sel = number_2old_jan_this/q %>% filter(year == (n_year-1), age == 2) %>% select(q)

abund_this =  est %>% filter(year == n_year) %>% select(number, biomass, year, age) %>% dplyr::rename(number_est = number, biomass_est = biomass) # get the abundance of this year (2022)
abund_this = left_join(abund_this, weight %>% filter(year == (n_year-1)), by = c("age"))

# 来年1月の資源量の計算（今年2歳魚以上）
next_year = NULL
for(i in unique(abund_this$age)){
  # # 1歳
  # temp = number_2old_jan_this_sel*1000
  # next_year = abind(next_year, temp, along = 1)
  if(i < 9){
    temp = (abund_this %>% filter(age == i) %>% select(number_est))*s_current
    next_year = rbind(next_year, temp)
  }
  if(i == 9){
    temp = ((abund_this %>% filter(age == i) %>% select(number_est)) + (abund_this %>% filter(age == i+1) %>% select(number_est)))*s_current
    next_year = rbind(next_year, temp)
  }
}

temp = data.frame(age = 2, number_est = number_2old_jan_this_sel) %>% dplyr::rename(number_est = number)
temp2 = data.frame(age = rep(3:10), number_est = next_year)
next_year = rbind(temp, temp2)

abund_abc = abund_this %>% mutate(next_year_number = next_year$number/1000) %>% mutate(next_year_biomass = next_year_number*weight/1000)

(total_number_next = sum(abund_abc$next_year_number))
(total_biomass_next = sum(abund_abc$next_year_biomass))

f_limit = 0.058 # fixed. F = F_40%
f_target = f_limit*0.8
z_abc = f_limit+M

# ABC
(abc_limit = (f_limit*(1-exp(-z_abc)))/z_abc*total_biomass_next)
(abc_target = (f_target*(1-exp(-z_abc)))/z_abc*total_biomass_next)

# re-estimation of ABC in this year
(total_biomass_this = sum(abund_abc$biomass_est))
(re_abc_limit = (f_limit*(1-exp(-z_abc)))/z_abc*total_biomass_this)
(re_abc_target = (f_target*(1-exp(-z_abc)))/z_abc*total_biomass_this)

# re-estimation of ABC last year
(total_biomass_last = sum(est %>% filter(year == (as.numeric(str_sub(Sys.Date(), 1, 4))-1)) %>% select(biomass)))
(re_abc_limit_last = (f_limit*(1-exp(-z_abc)))/z_abc*total_biomass_last)
(re_abc_target_last = (f_target*(1-exp(-z_abc)))/z_abc*total_biomass_last)


### fisheries catch, F, and fishing rate in this year (the second table in the document)
(rate_this = (exp(-0.125/2))*(1-exp(-f_current))*100)
(catch_this = trend %>% filter(year == 2021) %>% select(total)*(rate_this/100))


### fishing rate and F in ABC (the first table in the document)
(rate_limit = abc_limit/total_biomass_next*100)
(rate_target = abc_target/total_biomass_next*100)
(changeFpercent_limit = (0.058-f_current)*100/f_current)
(changeFpercent_target = (0.047-f_current)*100/f_current)


# ドキュメントに対応した表を作成．
# Markdownに表示させてドキュメントの作成・確認を効率化する．outputフォルダには出さない．
table_s1 = data.frame(Target_Limit = c("Target", "Limit"), 
                      ABC_ton = c(abc_target, abc_limit), 
                      漁獲割合 = c(rate_target, rate_limit), 
                      現状のF値からの増減 = c(changeFpercent_target$`mean(F)`, changeFpercent_limit$`mean(F)`))

# total_catch_pref = merge %>% gather(key = pref, value = tons, 2:ncol(merge)) %>% summarize(sum(tons)/1000)

table_s2 = data.frame(year = rep((n_year-5):n_year+1), 
                      資源量_ton = abind(trend %>% dplyr::filter(year > (n_year-5)) %>% select(total), total_biomass_next, along = 1), 
                      親魚量 = abind(srr %>% filter(year2 > (n_year-5)) %>% mutate(biomass2 = biomass/1000000) %>% select(biomass2), NA, along = 1), 
                      漁獲量_ton = abind(catchF %>% filter(year > (n_year-5)) %>% select(catch), catch_this, NA, along = 1), 
                      F = abind(fishing_trend %>% filter(year > (n_year-5), data == "F") %>% select(value), f_current, NA, along = 1), 
                      漁獲割合 = abind(fishing_trend %>% filter(year > (n_year-5), data == "rate") %>% select(value), rate_this, NA, along = 1))
colnames(table_s2) = c("年", "資源量_ton", "親魚量_ton", "漁獲量_ton", "F", "漁獲割合")
```





```{r fig9, echo=F, warning=F, message=F, results=F, include=F}
# R3年度まで: 宮城県の体長組成を宮城県+福島県+茨城県の漁獲量で引き延ばし，青森県の体長組成を青森県+岩手県の漁獲量で引き延ばし
# R4年度: 青森県と宮城県のみの体長組成を頻度グラフとして提出（つまり漁獲量で引き伸ばさない）


# step1. 各県の漁獲量データ ----------------------------------------------
# コードの全面的な修正が面倒であったため，必要のない県の漁獲量データも読み込むようになっている．でも使わないから大丈夫．

### aomori
ao2 = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "ao") %>% select(月, 数量kg) %>% dplyr::rename(catch_kg = 数量kg, month = 月) %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"))
ao_sum2 = ao2 %>% dplyr::group_by(season) %>% dplyr::summarize(sum_kg = sum(catch_kg))

### iwate
iwa2 = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "iwa") %>% select(-"合計", -"市場名", -"漁業種名", -"規格名") 
iwa2 = iwa2  %>% tidyr::gather(key = date, value = catch_kg, 1:ncol(iwa2)) %>% mutate(month = as.numeric(str_sub(date, 6, 8))) %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"))
iwa_sum2 = iwa2 %>% dplyr::group_by(season) %>% dplyr::summarize(sum_kg = sum(catch_kg))

### fukusima
fuku2 = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "fuku", startRow = 2) %>% na.omit()
colnames(fuku2) = c("month", "catch_kg")
fuku2 = fuku2 %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12")) 
fuku_sum2 = fuku2 %>% dplyr::group_by(season) %>% dplyr::summarize(sum_kg = sum(catch_kg))

### ibaraki
iba2 = read.xlsx(paste0(dir, "catch_pref.xlsx"), sheet = "iba", startRow = 4)
iba2 = iba2[-13, -2] 
iba2 = iba2 %>% mutate(month = rep(1:12)) %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12")) 
iba_sum2 = iba2 %>% na.omit() %>%dplyr::group_by(season) %>% dplyr::summarize(sum_kg = sum(総計))
iba_sum2[2, 1] = "1-6"
iba_sum2[is.na(iba_sum2)] = 0




# step2. 宮城県の体長組成 -----------------------------------------
# 以下の項目は引き継ぎ資料の見出に対応．ないと訳分からなくなるから残した．
# (1-B) きちじとこきちじの漁獲量---------------------------------------------------------
g_miya = read.csv(paste0(dir, "catch_miyagi.csv"), fileEncoding = fileEncoding)
#summary(g_miya)
g_miya = g_miya %>% mutate(ymd = as.Date(g_miya$年月日, format = "%Y/%m/%d")) %>% 
  dplyr::rename(mizuage = 日別水揚量, size = 魚種コード) %>% select(ymd, size, mizuage) %>% 
  mutate(year = as.numeric(str_sub(ymd, 1, 4)), month = as.numeric(str_sub(ymd, 6, 7)), day = as.numeric(str_sub(ymd, 9, 10))) %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"))
g_miya2 = g_miya %>% dplyr::group_by(size, year, month, season) %>% dplyr::summarize(total = sum(mizuage))



# (1-C) こきちじの体長組成---------------------------------------------------------
tai_miya = read.csv(paste0(dir, "taityo_miyagi_fresco.csv"), fileEncoding = fileEncoding)
#summary(tai_miya)
tai_miya = tai_miya %>% filter(銘柄コード == 91) # 別の種や体長組成の算出に不必要なデータが入っている場合があるため，ここで念のためフィルターをかける
tai_miya = tai_miya %>% dplyr::rename(ymd = 漁獲年月日, start = 開始の階級値, do = 度数) %>% select(ymd, start, do) %>% mutate(year = as.numeric(str_sub(ymd, 1, 4)), month = as.numeric(str_sub(ymd,5, 6)), day = as.numeric(str_sub(ymd, 7, 8))) %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"))
# 度数 = 尾数．つまり，「開始の階級値」サイズの個体が度数分だけあったってこと．
set.seed(1)
rand = runif(nrow(tai_miya)*100) %>% matrix(ncol = 100)
loop = matrix(NA, ncol = 101, nrow = nrow(tai_miya))
loop[, 1] = tai_miya$start
for(i in 1:100){
  loop[, i+1] = (0.8131*(loop[, 1]+rand[, i])+0.16238)%/%1
}
loop = loop[, -1] %>% as.data.frame() %>% mutate(year = tai_miya$year, season = tai_miya$season, month = tai_miya$month, do = tai_miya$do) %>% tidyr::gather(key = times, value = taityo, 1:100) %>% dplyr::rename(number = do)
loop2 = loop %>% group_by(year, season, times, taityo) %>% dplyr::summarize(count = sum(number))
summary(loop2)
round2 = function(x, d=0) {
  p = 10^d
  return((x * p * 2 + 1) %/% 2 / p)
}
tai_miya2 = loop2 %>% dplyr::group_by(year, season, taityo) %>% dplyr::summarize(mean = round2(mean(count), 0))
weight = data.frame(taityo = rep(5:19)) %>% mutate(weight = 0.00000531472*((taityo+0.5)*10)^3.30527)
tai_miya2 = left_join(tai_miya2, weight, by = "taityo") %>% mutate(total_weight_kg = (mean*weight)/1000)



# (1-D) きちじの体長組成---------------------------------------------------------
yatyo = read.csv(paste0(dir, "yatyo_miyagi.csv"), fileEncoding = fileEncoding)
# yatyo = read.xlsx("箱入れキチジ体長.xlsx", sheet = "2019")
# head(yatyo)
# summary(yatyo)
yatyo = yatyo %>% dplyr::rename(ymd = 調査年月日, meigara = 銘柄, n_hako = 箱数)
yatyo = yatyo %>% tidyr::gather(key = no, value = zentyo, 11:ncol(yatyo)) %>% 
  mutate(year = as.numeric(str_sub(ymd, 1, 4)), month = as.numeric(str_sub(ymd, 6, 7)), gyokaku_kg = n_hako*7, gyokaku_n = meigara*n_hako) %>% 
  mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"), tag = paste(ymd, meigara, sep = '_')) %>% na.omit()
yatyo = yatyo %>% mutate(day = ifelse(yatyo$month/1 < 10, as.numeric(str_sub(yatyo$ymd, 8, 9)), as.numeric(str_sub(yatyo$ymd, 9, 10))))
# summary(yatyo)
sokutei_n = yatyo %>% group_by(ymd, meigara) %>% dplyr::summarize(sokutei_n = n())
# summary(sokutei_n)
yatyo = left_join(yatyo, sokutei_n, by = c("ymd", "meigara")) %>% mutate(yatyo, rate = gyokaku_n/sokutei_n)
# summary(yatyo)
tag_rate = yatyo %>% select(tag, rate) %>% distinct(.keep_all = T) # tag = paste(ymd, meigara, sep = '_')
set.seed(1)
rand = runif(nrow(yatyo)*100) %>% matrix(ncol = 100)
loop = matrix(NA, ncol = 101, nrow = nrow(yatyo))
loop[, 1] = yatyo$zentyo
for(i in 1:100){
  loop[, i+1] = (0.8131*(loop[, 1]+rand[, i])+0.16238)%/%1
}
ncol(loop)
nrow(loop)
loop = loop[, -1] %>% as.data.frame() %>% mutate(year = yatyo$year, tag = yatyo$tag) %>% gather(key = times, value = taityo, 1:100)
loop2 = loop %>% group_by(year, tag, times, taityo) %>% dplyr::summarize(count = n())
loop2 = left_join(loop2, tag_rate, by = "tag") %>% mutate(number = count*rate, month = as.numeric(str_sub(tag, 6, 7))) %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"))
m_sosei = loop2 %>% group_by(year, times, taityo, season) %>% dplyr::summarize(sum = sum(number))
total_sosei = m_sosei %>% group_by(year, taityo, season) %>% dplyr::summarize(total_n = round2(mean(sum), 0))



# (1-E) ---------------------------------------------------------
kiti = total_sosei %>% mutate(weight = 0.00000531472*((taityo+0.5)*10)^3.30527) %>% mutate(total_weight_kg = (total_n*weight)/1000, species = 'kiti') %>% select(year, season, taityo, total_n, weight, total_weight_kg, species) %>% dplyr::rename(mean = total_n)
kokiti = tai_miya2 %>% mutate(species = 'kokiti')
miyagi = rbind(kiti, kokiti)
sum_miya = miyagi %>% dplyr::group_by(year, season, species) %>% dplyr::summarize(sum = sum(total_weight_kg))
unique(g_miya2$size)
summary(g_miya2)
total_g_miyagi = g_miya2 %>% dplyr::group_by(year, season, size) %>% dplyr::summarize(sum = sum(total))
total_g_miyagi$species = ifelse(total_g_miyagi$size == "きちじ", 'kiti', 'kokiti')

rate = left_join(sum_miya, total_g_miyagi, by = c('year', 'season', 'species')) %>% mutate(rate = sum.y/sum.x)
miyagi = left_join(miyagi, rate, by = c('year', 'season', 'species')) 
miyagi = miyagi %>% mutate(weight2 = mean*rate) %>% mutate(pref = 'Miyagi')
total = miyagi %>% dplyr::group_by(year, season) %>% dplyr::summarize(total = sum(weight2)) %>% mutate(pref = "miyagi") %>% as.data.frame()
# fukuiba_mae = 6814.1+0　#fuku+iba
# fukuiba_usiro = 1536.3+30 

fukuiba_mae = fuku_sum2 %>% filter(season == "1-6") %>% select(sum_kg) + iba_sum2 %>% filter(season == "1-6") %>% select(sum_kg)
fukuiba_usiro = fuku_sum2 %>% filter(season == "7-12") %>% select(sum_kg) + iba_sum2 %>% filter(season == "7-12") %>% select(sum_kg)
rate_fukuiba_mae = (total %>% filter(season == '1-6') %>% select(total) + fukuiba_mae)/total %>% filter(season == '1-6') %>% select(total)
rate_fukuiba_usiro = (total %>% filter(season == '7-12') %>% select(total) + fukuiba_usiro)/total %>% filter(season == '7-12') %>% select(total)
head(miyagi)
fukuiba = miyagi %>% dplyr::group_by(year, season, taityo) %>% dplyr::summarize(sum = sum(weight2))
fukuiba$rate = ifelse(fukuiba$season == '1-6', as.numeric(rate_fukuiba_mae), as.numeric(rate_fukuiba_usiro)) 
fukuiba = fukuiba %>% mutate(weight2 = sum*rate, pref = 'South of Miyagi') 

# head(fukuiba)
# head(miyagi)

# 宮城と福島+茨城の2種類のデータが入っている -> 宮城だけ抜き出せば良い
fig = rbind(miyagi %>% select(year, season, taityo, weight2, pref), fukuiba %>% select(year, season, taityo, weight2, pref)) 




# step3. 青森県の体長組成 -----------------------------------------------
# 以下の項目は引き継ぎ資料の見出に対応．ないと訳分からなくなるから残した．
# (3) 八戸 ------------------------------------------------------------------
tai_hati = read.csv(paste0(dir, "hati_sokutei.csv"), fileEncoding = fileEncoding)

# 規格コード
code_data = read.csv(paste0(dir, "hati_sokutei2019.csv"), fileEncoding = fileEncoding)
(code = data.frame(規格名 = unique(code_data$規格名)))
code$CD = c(NA, 13, 27, 28, 7, 8, 7, 7, 8, 31, 68, 31, 8, NA, 7, 8, NA, 27)
(code2 = data.frame(規格名 = unique(tai_hati$規格名)))

tai_hati = left_join(tai_hati, code, by = "規格名")
tai_hati[is.na(tai_hati)] = 0
tai_hati = tai_hati %>% select(年, 月, 漁法名, CD, 入数, 月間数量.Ｋｇ.)
colnames(tai_hati) = c("year", "month", "fisheries", "kikaku", "irisu", "kg")



# 青森県の基データは銘柄と入尾数がスペース区切で一つのセルに入力されているため，エクセルの区切り位置機能を使って銘柄と入尾数のセルを分割してhati_sokutei.csvを作成している
# しかし，年によってスペースの入り方が違うため，このあたりで入尾数をうまく引っ張り出せるように調整する必要がある
# tai_hati$irisu = tai_hati$irisu%/%10 # R4年度にコメントアウト


tai_hati = tai_hati %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"), iri_bisu = ifelse(kikaku == 13, 'P', ifelse(kikaku == 7, 'S', as.numeric(str_sub(irisu, -2, -1)))))

# 平均体長を算出するパラメタ
a = 473.69 # fixed
b = -0.2583 # fixed
cv = 0.0448 # fixed

# PとS規格以外の箱を対象に，平均体長を求める
kg = tai_hati %>% group_by(year, season, iri_bisu) %>% dplyr::summarize(sum = sum(kg)) %>% filter(iri_bisu != "S") %>% filter(iri_bisu != "P") %>% mutate(n_iri_bisu = as.numeric(iri_bisu))
kg = kg %>% filter(n_iri_bisu > 1) %>% na.omit() %>% mutate(hako = sum/7, gyokaku_bisu = hako*n_iri_bisu)
kg = kg %>% mutate(meanBL = a*n_iri_bisu^b) %>% mutate(SD = meanBL*cv)

# 正規分布を仮定して，各体長クラスが出現する確率を算出
pn = NULL
length = c(seq(50, 350, 10), 1000)
for(i in 1:length(length)){
  #i = 21
  temp = matrix(NA, ncol = 2, nrow = length(kg$n_iri_bisu))
  for(j in 1:length(kg$n_iri_bisu)){
    temp[j, 1] = pnorm(length[i], kg$meanBL[j], kg$SD[j])
    temp[j, 2] = pnorm(length[i+1], kg$meanBL[j], kg$SD[j])
  }
  temp2 = (temp[,2]-temp[,1]) %>% data.frame %>% mutate(iri_bisu = kg$n_iri_bisu, gyokaku_bisu = kg$gyokaku_bisu, season = kg$season, BL = paste0(length[i+1]))
  pn = rbind(pn, temp2)
}

colnames(pn)[1] = "prob"
pn$number = pn$prob*pn$gyokaku_bisu
pn2 = pn %>% dplyr::group_by(season, BL) %>% dplyr::summarize(total_number = sum(number))
pn2$taityo = as.numeric(pn2$BL)/10 # with message about getting NA
pn2$BL = as.numeric(pn2$BL) 
pn2 = na.omit(pn2)




# PとS規格の体長組成
# 八戸庁舎で測定したデータを使う
ps = read.csv(paste0(dir, "taityo_FRA.csv"), fileEncoding = fileEncoding) %>% mutate(season = ifelse(between(month, 1, 6), "1-6", "7-12"), tag = paste(taityo, meigara, month, total_number_in_box, sep = "_"), tag_box = paste(month, total_number_in_box,meigara,  sep = "_"), taityo2 = taityo%/%10, meigara = ifelse(meigara == "SS", "P", "S"))
comp_ps = ps %>% dplyr::group_by(season, taityo2, meigara) %>% dplyr::summarize(count = n()) # 八戸庁舎で測定したSとSSサイズの体長組成

n_total = comp_ps %>% dplyr::group_by(season, meigara)  %>% dplyr::summarize(n_total = sum(count))
n_total = n_total %>% mutate(n_box = c(3, 2)) %>% mutate(n_iri_bisu = n_total/n_box)


stat_ps = ps %>% dplyr::group_by(season, meigara) %>% dplyr::summarize(meanBL = mean(taityo), SD = sd(taityo))
comp_ps = left_join(comp_ps, n_total, by = c("season", "meigara"))
comp_ps = comp_ps %>% mutate(freq = count/n_total) %>% arrange(taityo2)

# Pサイズ
data_p = comp_ps %>% filter(meigara == "P") %>% arrange(taityo2)
temp_p = matrix(0, ncol = 1, nrow = nrow(data_p))
for(k in 2:nrow(data_p)){
  # k = 2
  temp_p[k] = data_p$freq[k] + temp_p[k-1]
}

# Sサイズ
data_s = comp_ps %>% filter(meigara == "S") %>% arrange(taityo2)
temp_s = matrix(0, ncol = 1, nrow = nrow(data_s))
for(k in 2:nrow(data_s)){
  # k = 2
  temp_s[k] = data_s$freq[k] + temp_s[k-1]
}
(stat_ps = ps %>% dplyr::group_by(season, meigara) %>% plyr::summarize(meanBL = mean(taityo), SD = sd(taityo)))


temp1 = data_frame(freq2 = temp_p, taityo2 = data_p$taityo2, meigara = "P", season = "1-6")
temp2 = data_frame(freq2 = temp_s, taityo2 = data_s$taityo2, meigara = "S", season = "1-6")
temp = rbind(temp1, temp2)
comp_ps = full_join(comp_ps, temp, by = c("taityo2", "season", "meigara")) %>% mutate(n_catch = n_iri_bisu*n_box) %>% mutate(total_number = freq2*n_catch)
sokutei = data_frame(season = comp_ps$season, taityo = comp_ps$taityo2*10, total_number = comp_ps$total_number) %>% mutate(BL = taityo*10)

summary(pn2)
summary(sokutei)
all_ao = rbind(pn2, sokutei)



ao = all_ao %>% filter(taityo < 100) %>% mutate(weight = 0.00001867*(taityo*10)^3.068) %>% mutate(biomass = weight*total_number)
total_ao = ao %>% dplyr::group_by(season) %>% dplyr::summarize(total = sum(biomass)/1000)
(tai_hati %>% dplyr::group_by(season) %>% dplyr::summarize(sum = sum(kg)))

# catch_mae = 58551+108677 #aomori+iwate?
# catch_usiro = 4105.3+44273.1
catch_mae = ao_sum2 %>% filter(season == "1-6") %>% select(sum_kg) + iwa_sum2 %>% filter(season == "1-6") %>% select(sum_kg)
catch_usiro = ao_sum2 %>% filter(season == "7-12") %>% select(sum_kg) + iwa_sum2 %>% filter(season == "7-12") %>% select(sum_kg)


# # 青森＋岩手での引き延ばし
# total_ao = total_ao %>% mutate(catch = ifelse(total_ao$season == "1-6", as.numeric(catch_mae), as.numeric(catch_usiro))) %>% mutate(rate = catch/total)
# ao = left_join(ao, total_ao, by = "season") %>% mutate(number = rate*total_number)

# 青森の漁獲量だけ使う
total_ao = total_ao %>% mutate(catch = ifelse(total_ao$season == "1-6", as.numeric(ao_sum2 %>% filter(season == "1-6") %>% select(sum_kg)), as.numeric(ao_sum2 %>% filter(season == "7-12") %>% select(sum_kg))))
ao = left_join(ao, total_ao, by = "season")




# step4. figure ---------------------------------------------------
#=== 引き延ばす時のコード ===#
# fig2 = fig %>% dplyr::group_by(taityo) %>% dplyr::summarize(total_number = sum(weight2)) # 宮城以南も使うとき
# ao2 = ao %>% dplyr::group_by(taityo) %>% dplyr::summarize(total_number = sum(total_number))
# tohoku = rbind(fig2 %>% mutate(area = "宮城県以南"), ao2 %>% mutate(area = "岩手県以北")) # 引き延ばすとき
# tohoku = tohoku %>% dplyr::group_by(area, taityo) %>% dplyr::summarize(total_number = sum(total_number))

# unique(tohoku$area)
# levels(tohoku$area) 
# tohoku$area = factor(tohoku$area, levels = c("岩手県以北", "宮城県以南"))
# g = ggplot(tohoku %>% filter(taityo < 50), aes(x = taityo, y = total_number/10000, fill = area))
# b = geom_bar(stat = "identity", width = 0.5, colour = "black")
# lab = labs(x = "体長（cm）", y = "漁獲尾数 (万尾)", fill = "")
# col_catch = c("white", "grey0")
# c = scale_fill_manual(values = col_catch)
# th = theme(panel.grid.major = element_blank(),
#            panel.grid.minor = element_blank(),
#            axis.text.x = element_text(size = rel(1.8), colour = "black"),
#            axis.text.y = element_text(size = rel(1.8), colour = "black"),
#            axis.title.x = element_text(size = rel(1.5)),
#            axis.title.y = element_text(size = rel(1.5)),
#            legend.title = element_blank(),
#            legend.text = element_text(size = rel(1.8)),
#            strip.text.x = element_text(size = rel(1.8)),
#            legend.position = c(0.85, 0.8),
#            legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
# fig9 = g+b+lab+c+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(expand = c(0,0), breaks=seq(2, 36, by = 2))+scale_y_continuous(expand = c(0,0),limits = c(0, 11))



#=== 引き伸ばさない時のコード ===#
fig2 = fig %>% filter(pref == "Miyagi") %>% dplyr::group_by(taityo) %>% dplyr::summarize(total_number = sum(weight2))
ao2 = ao %>% dplyr::group_by(taityo) %>% dplyr::summarize(total_number = sum(total_number))

tohoku = rbind(fig2 %>% mutate(area = "Miyagi"), ao2 %>% mutate(area = "青森"))
tohoku = tohoku %>% dplyr::group_by(area, taityo) %>% dplyr::summarize(total_number = sum(total_number))

hist = tohoku %>% dplyr::group_by(area) %>% dplyr::summarize(sum = sum(total_number))
hist_aomori = left_join(tohoku, hist, by = "area") %>% filter(area == "青森") %>% mutate(freq = total_number/sum) %>% mutate(area = "青森県")
hist_miyagi = left_join(tohoku, hist, by = "area") %>% filter(area == "Miyagi") %>% mutate(freq = total_number/sum) %>% mutate(area = "宮城県")
summary(hist_aomori)

hist = rbind(hist_aomori, hist_miyagi)
hist = hist %>% filter(taityo < 50)

hist2 = data.frame(taityo = rep(max(hist$taityo):(max(hist$taityo)+2), each = 2), area = c("青森県", "宮城県"), freq = 0)
hist = rbind(hist %>% select(area, taityo, freq), hist2)
hist$area = factor(hist$area, levels = c("青森県", "宮城県"))


g = ggplot(hist %>% filter(freq != 0), aes(x = taityo, y = freq))
b = geom_bar(stat = "identity", width = 0.5, colour = "black")
f = facet_wrap( ~ area, ncol = 1)
lab = labs(x = "体長（cm）", y = "頻度", fill = "")
col_catch = c("white", "grey0")
c = scale_fill_manual(values = col_catch)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.85, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
fig9 = g+b+f+lab+c+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(expand = c(0,0), breaks=seq(0, 40, by = 2))+scale_y_continuous(expand = c(0,0),limits = c(0, max(hist$freq)+0.01))
```





```{r okisoko, echo=F, warning=F, message=F, results=F, include=F}
# step 1 ----------------------------------------------------
# 今年の沖底漁獲量
# 2020年は尻屋崎が尻矢崎と入力されているもよう
# 襟裳西は抜く
okisoko = read.xlsx(paste0(dir, "okisoko_after2019.xlsx"), sheet = paste0((n_year-1)))
summary(okisoko$魚種名)
# colnames(okisoko)
# summary(okisoko)
okisoko = okisoko %>% mutate(method = ifelse(漁法 == 102, "2そう曳き", ifelse(漁法 == 103, "トロール", "かけ廻し"))) %>%
  mutate(pref = ifelse(県コード == 13, "青森", ifelse(県コード == 14, "岩手", ifelse(県コード == 15, "宮城", ifelse(県コード == 18, "茨城", "福島"))))) %>% select(漁区名, method, pref, 漁獲量の合計, 網数の合計) %>% dplyr::rename(area = 漁区名, catch = 漁獲量の合計, effort = 網数の合計) %>% mutate(cpue = catch/effort) %>% filter(area != "襟裳西")
head(okisoko)
colnames(okisoko)

catch_t1 = okisoko %>% dplyr::group_by(pref, method, area) %>% dplyr::summarize(sum_kg = sum(catch)) %>% tidyr::spread(key = area, value = sum_kg)
catch_t1[is.na(catch_t1)] = 0
catch_t2 = okisoko %>% dplyr::group_by(area) %>% dplyr::summarize(sum_kg = sum(catch))
catch_t2[is.na(catch_t2)] = 0

# 表2の作成
catch_t3 = okisoko %>% dplyr::group_by(method, area) %>% dplyr::summarize(sum_kg = sum(catch)) %>% tidyr::spread(key = method, value = sum_kg)
catch_t3[is.na(catch_t3)] = 0
table2 = catch_t3 %>% gather(key = method, value = kg, 2:ncol(catch_t3)) %>% dplyr::group_by(area) %>% dplyr::summarize(catch_t = sum(kg)/1000)
table2 = rbind(table2, table2 %>% dplyr::summarize(catch_t = sum(catch_t)) %>% mutate(area = "total"))

# # SS用のデータ
# ss_catch = catch_t3 %>% gather(key = method, value = catch_t, 2:ncol(catch_t3)) %>% dplyr::group_by(method) %>% dplyr::summarize(catch_t = sum(catch_t)/1000)

# 表3の作成
effort_t1 = okisoko %>% dplyr::group_by(method, area) %>% dplyr::summarize(sum= sum(effort)) %>% tidyr::spread(key = method, value = sum)
effort_t1[is.na(effort_t1)] = 0

effort_t2 = okisoko %>% dplyr::group_by(pref, method, area) %>% dplyr::summarize(sum = sum(effort)) %>% tidyr::spread(key = area, value = sum)
effort_t2[is.na(effort_t2)] = 0

# catch_t2 = ddply(okisoko, .(area), summarize, sum_kg = sum(catch))
# catch_t2[is.na(catch_t2)] = 0
# catch_t3 = ddply(okisoko, .(method, area), summarize, sum_kg = sum(catch)) %>% tidyr::spread(key = method, value = sum_kg)
# catch_t3[is.na(catch_t3)] = 0
# effort_t1 = ddply(okisoko, .(method, area), summarize, sum= sum(effort)) %>% tidyr::spread(key = method, value = sum)
# effort_t1[is.na(effort_t1)] = 0
# effort_t2 = ddply(okisoko, .(pref, method, area), summarize, sum = sum(effort)) %>% tidyr::spread(key = area, value = sum)
# effort_t2[is.na(effort_t2)] = 0


# step 2; effort trend ----------------------------------------------------
# ~2018まで
eff_old = read.csv(paste0(dir, "effortdata_old.csv"), fileEncoding = fileEncoding)
eff_old = eff_old %>% dplyr::group_by(method, year) %>% dplyr::summarize(sum = sum(effort))

# 2019-(最新年-1)までのエフォートデータの作成
eff19 = NULL
for(i in 2019:(n_year-2)){
  oki2019 = read.xlsx(paste0(dir, "okisoko_after2019.xlsx"), sheet = paste0(i)) %>% filter(漁区名 != "襟裳西")
  oki2019 = oki2019 %>% mutate(method = ifelse(漁法 == 102, "2そう曳き", ifelse(漁法 == 103, "トロール", "かけ廻し"))) %>%
    mutate(pref = ifelse(県コード == 13, "青森", ifelse(県コード == 14, "岩手", ifelse(県コード == 15, "宮城", ifelse(県コード == 18, "茨城", "福島"))))) %>% select(漁区名, method, pref, 漁獲量の合計, 網数の合計) %>% dplyr::rename(area = 漁区名, catch = 漁獲量の合計, effort = 網数の合計) %>% mutate(cpue = catch/effort)
  temp_eff = oki2019 %>% dplyr::group_by(method) %>% dplyr::summarize(sum = sum(effort)) %>% mutate(year = as.numeric(paste(i)))
  
  eff19 = rbind(eff19, temp_eff)
}

# oki2019 = read.xlsx(paste0(dir, "okisoko_after2019.xlsx"), sheet = "2019") %>% filter(漁区名 != "襟裳西")
# oki2019 = oki2019 %>% mutate(method = ifelse(漁法 == 102, "2そう曳き", ifelse(漁法 == 103, "トロール", "かけ廻し"))) %>%
#   mutate(pref = ifelse(県コード == 13, "青森", ifelse(県コード == 14, "岩手", ifelse(県コード == 15, "宮城", ifelse(県コード == 18, "茨城", "福島"))))) %>% select(漁区名, method, pref, 漁獲量の合計, 網数の合計) %>% dplyr::rename(area = 漁区名, catch = 漁獲量の合計, effort = 網数の合計) %>% mutate(cpue = catch/effort)
# eff19 = 
# 
# eff19 = ddply(oki2019, .(method), summarize, sum = sum(effort))
# eff19$year = 2019


# 最新年のエフォート; 上の方で使っている
eff = okisoko %>% dplyr::group_by(method) %>% dplyr::summarize(sum = sum(effort)) %>% dplyr::mutate(year = as.numeric(paste((n_year-1))))


# 統合
eff = rbind(eff_old, eff19, eff)


# カテゴリと序列の設定
unique(eff$method)
# eff = eff %>% dplyr::mutate(label = ifelse(eff$method == "かけ廻し", "尻屋崎〜岩手沖のかけ廻し", ifelse(eff$method == "トロール", "金華山~房総のトロール", "岩手沖の2そう曳き")))
eff$label = ifelse(eff$method == "かけ廻し", "尻屋崎〜岩手沖のかけ廻し", ifelse(eff$method == "トロール", "金華山〜房総のトロール", "岩手沖の2そう曳き"))
levels(eff$label)
eff$label = factor(eff$label, levels = c("尻屋崎〜岩手沖のかけ廻し", "岩手沖の2そう曳き", "金華山〜房総のトロール"))


g = ggplot(eff, aes(x = year, y = sum/1000, shape = label, linetype = label, fill = label))
p = geom_point(size = 3)
l = geom_line(size = 0.5)
lab = labs(x = "年", y = "有漁網数 (千)", shape = "漁業種")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = 8, colour = "black"),
           axis.text.y = element_text(size = 8, colour = "black"),
           axis.text = element_text(family = "Arial", color = "black"),
           axis.title.x = element_text(size = 11),
           axis.title.y = element_text(size = 11),
           axis.ticks = element_line(size = 0.15, colour = "black"),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(0.8)),
           strip.text.x = element_text(size = rel(0.8)),
           legend.position = c(0.755, 0.763),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
fig6 = g+l+p+lab+theme_bw(base_family = "HiraginoSans-W3")+th+scale_x_continuous(expand = c(0, 0.5), breaks=seq(1972, 2020, by = 5))+scale_y_continuous(expand = c(0,0),limits = c(0, 30))+scale_linetype_manual(values = c("solid", "solid", "solid"),)+ guides(linetype=FALSE, fill = FALSE)+scale_shape_manual(values = c(22, 17, 18))+scale_fill_manual(values = c('white','black','black'))+scale_size_manual(values = c(3,3,4))




# step 3; CPUE trend ----------------------------------------------------------
# -2018までのデータ
cpue_old = read.csv(paste0(dir, "okisoko_old.csv"), fileEncoding = fileEncoding)
unique(cpue_old$method)

# 2019以降のデータ
sheets = excel_sheets(paste0(dir, "okisoko_after2019.xlsx")) #シート名の取得
cpue = NULL
for(i in 1:length(sheets)){
  data = read.xlsx(paste0(dir, "okisoko_after2019.xlsx"), sheet = sheets[i])
  data2 = data %>% mutate(method = ifelse(漁法 == 102, "2そう曳き", ifelse(漁法 == 103, "トロール", "かけ廻し"))) %>%
    mutate(pref = ifelse(県コード == 13, "青森", ifelse(県コード == 14, "岩手", ifelse(県コード == 15, "宮城", ifelse(県コード == 18, "茨城", "福島"))))) %>% select(漁区名, method, pref, 漁獲量の合計, 網数の合計) %>% filter(漁区名 != "襟裳西")
  
  temp_cpue = data2 %>% group_by(method) %>% dplyr::summarize(effort = sum(網数の合計), catch = sum(漁獲量の合計)) %>% mutate(year = as.numeric(paste0(sheets[i])))
  cpue = rbind(cpue, temp_cpue)
}

cpue2 = rbind(cpue_old, cpue) %>% mutate(cpue = catch/effort) 
mean_cpue = cpue2 %>% dplyr::group_by(method) %>% dplyr::summarize(m_cpue = mean(cpue))
cpue2 = left_join(cpue2, mean_cpue, by = "method") %>% mutate(cpue2 = cpue/m_cpue) %>% mutate(bunsi = catch*cpue2)

y_cpue = cpue2 %>% dplyr::group_by(year) %>% dplyr::summarize(bunsi = sum(bunsi))
y_catch = cpue2 %>% dplyr::group_by(year) %>% dplyr::summarize(total_catch = sum(catch))
w_cpue = left_join(y_cpue, y_catch, by = "year") %>% mutate(weighted_cpue = bunsi/total_catch)

cpue2$label = ifelse(cpue2$method == "かけ廻し", "尻屋崎〜岩手沖のかけ廻し", ifelse(cpue2$method == "トロール", "金華山~房総のトロール", "岩手沖の2そう曳き"))
unique(cpue2$label)
levels(cpue2$label)
cpue2$label = factor(cpue2$label, levels = c("尻屋崎〜岩手沖のかけ廻し", "岩手沖の2そう曳き", "金華山~房総のトロール"))

# 表4の作成
table4 = data2  %>% dplyr::group_by(method,漁区名) %>% dplyr::summarize(effort = sum(網数の合計), catch = sum(漁獲量の合計))
table4$cpue = table4$catch/table4$effort

# SS用のCPUEデータの作成
ss_cpue = data2  %>% dplyr::group_by(method) %>% dplyr::summarize(effort = sum(網数の合計), catch_t = sum(漁獲量の合計)/1000)
ss_cpue$cpue = ss_cpue$catch_t/ss_cpue$effort

### かけ廻し
g = ggplot(cpue2 %>% filter(method == "かけ廻し"), aes(x = year, y = cpue, shape = label, fill = label))
p = geom_point(shape = 22, size = 4, fill = "white")
l = geom_line(linetype = "dotted", size = 1)
lab = labs(x = "年", y = "CPUE  (kg/網)", shape = "")
f = facet_wrap(~ label, ncol = 1)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_blank(),
           # axis.title.y = element_text(size = rel(2)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)))
kake = g+l+p+lab+f+theme_bw(base_family = "HiraKakuPro-W3")+th+theme(legend.position = 'none')+scale_x_continuous(breaks=seq(1972, 2020, by = 5), expand=c(0, 0.5))+scale_y_continuous(limits = c(0, 60))

### 2そう
g = ggplot(cpue2 %>% filter(method == "2そう曳き"), aes(x = year, y = cpue, shape = label))
p = geom_point(shape = 17, size = 5)
l = geom_line(linetype = "solid", size = 1)
lab = labs(x = "年", y = "CPUE  (kg/網)", shape = "")
f = facet_wrap(~ label, ncol = 1)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_blank(),
           # axis.title.y = element_text(size = rel(2)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)))
niso = g+p+l+lab+f+theme_bw(base_family = "HiraKakuPro-W3")+ theme(legend.position = 'none')+th+theme(legend.position = 'none')+scale_x_continuous(breaks=seq(1972, 2020, by = 5), expand = c(0, 0.5))+scale_y_continuous(limits = c(0, 300))


### トロール
g = ggplot(cpue2 %>% filter(method == "トロール"), aes(x = year, y = cpue, shape = label))
p = geom_point(shape = 18, size = 6)
l = geom_line(linetype = "dotted", size = 1)
lab = labs(x = "年", y = "CPUE  (kg/網)", shape = "")
f = facet_wrap(~ label, ncol = 1)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_blank(),
           # axis.title.y = element_text(size = rel(2)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)))
tra = g+p+l+lab+f+theme_bw(base_family = "HiraKakuPro-W3")+ theme(legend.position = 'none')+th+theme(legend.position = 'none')+scale_x_continuous(breaks=seq(1972, 2020, by = 5), expand=c(0, 0.5))+scale_y_continuous(limits = c(0, 120))


### weighted CPUE
w_cpue$label = "太平洋北部"
g = ggplot(w_cpue, aes(x = year, y = weighted_cpue))
p = geom_point(shape = 20, size = 6)
l = geom_line(size = 0.6, linetype = "solid")
lab = labs(x = "年", y = "重み付CPUE \n（相対値）", shape = "")
f = facet_wrap(~ label, ncol = 1)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           # axis.title.x = element_text(size = rel(2)),
           # axis.title.y = element_text(size = rel(2)),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)))
w = g+p+l+lab+f+theme_bw(base_family = "HiraKakuPro-W3")+ theme(legend.position = 'none')+th+theme(legend.position = 'none')+scale_x_continuous(breaks=seq(min(w_cpue$year), max(w_cpue$year), by = 5), expand=c(0, 0.5))+scale_y_continuous(limits = c(0, 3))
# fig8 = grid.arrange(kake, niso, tra, w, ncol = 1)
```





```{r figA3-1, echo=F, warning=F, message=F, results=F, include=F}
lonlat = read.xlsx(paste0(dir, "操業記録データ2021.xlsx"))
lonlat = lonlat[, c(2,3,4,9:12)]
colnames(lonlat)
colnames(lonlat) = c("station_code", "depth", "ami", "lat1", "lat2", "lon1", "lon2")
summary(lonlat)
lonlat = lonlat %>% mutate(lat = lat1+(round(lat2)/60), lon = lon1+(round(lon2)/60), tag = paste0(station_code, depth, "_", ami))

trawl_length = read.csv(paste0(dir, "trawl_ns_length2.csv"), fileEncoding = fileEncoding)
trawl_length3 = trawl_length[, c(10,11,12)]
colnames(trawl_length3)
colnames(trawl_length3) = c("station_code", "depth", "ami")
summary(trawl_length3)
trawl_length3 = trawl_length3 %>% mutate(tag = paste0(station_code, depth, "_", ami))
length(unique(lonlat$tag))
length(unique(trawl_length3$tag))
trawl_length3 = left_join(trawl_length3, lonlat %>% select(-station_code, -depth), by = "tag") %>% distinct(tag, .keep_all = TRUE)
levels(trawl_length3$station_code)
summary(trawl_length3)

### map
tohoku <- data.frame(read.csv(paste0(dir, "marmap_coord.csv"), fileEncoding = fileEncoding))
colnames(tohoku) <- c("long","lat","depth")
check = tohoku[tohoku$depth<0 & tohoku$depth>=-1300,]
summary(check)

japan <- map_data("japan")
japan2 <- japan
japan2$long <- japan$long-0.01
g <- ggplot(subset(tohoku[tohoku$depth<0 & tohoku$depth>=-1300,]),aes(long, lat))
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.5), colour = "black"),
           axis.text.y = element_text(size = rel(1.5), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           strip.text.x = element_text(size = rel(1.5)),
           plot.title = element_text(size = rel(1.5)),
           legend.title = element_text(size = rel(1.5)),
           legend.text = element_text(size = rel(1.5)))
fig_a31a = g + geom_polygon(data = japan2, group = japan$group, fill= "gray50", colour= "gray50")  + coord_map(xlim = c(140.5, 143), ylim = c(36, 42)) + stat_contour(aes(z=depth),binwidth=200,colour="black")+theme_bw(base_family = "HiraKakuPro-W3")+th+geom_point(data = trawl_length3, aes(x = lon, y = lat, shape = station_code), size = 3)+scale_shape_manual(values = c(15, 4, 17, 8, 18, 16, 1, 2))+labs(title = "(A)", x = "経度", y = "緯度", shape = "調査ライン")+scale_x_continuous(breaks=seq(140.5, 143, by = 1), expand = c(0, 0.5))


trawl_length = read.xlsx(paste0(dir, "q_魚種別体長別資源量2021.xlsx")) %>% filter(和名 == "キチジ")
# trawl_length = read.csv("trawl_ns_length2.csv", fileEncoding = fileEncoding)
trawl_length1 = trawl_length[, c(6,10,11,15)]
colnames(trawl_length1)
colnames(trawl_length1) = c("NS", "station_code", "depth", "total_number")
summary(trawl_length1)
number_at_depth = trawl_length1 %>% dplyr::group_by(station_code, depth) %>% dplyr::summarize(total = sum(total_number))
# number_at_depth$depth2 = as.factor(number_at_depth$depth)
unique(number_at_depth$depth)
number_at_depth$depth2 = factor(number_at_depth$depth, levels = c("150", "250", "350", "450", "550", "650", "750", "900"))
g = ggplot(number_at_depth, aes(x = depth2, y = total/1000))
b = geom_bar(stat = "identity", width = 1, colour = "grey50")
lab = labs(x = "水深（m）", y = "資源密度", title = "(B)")
f = facet_wrap(~ station_code, ncol = 2)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.5), angle = 90, colour = "black"),
           axis.text.y = element_text(size = rel(1.5), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(1.5)),
           strip.text.x = element_text(size = rel(1.5)),
           plot.title = element_text(size = rel(1.5)))
fig_a31b = g+b+lab+f+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_y_continuous(expand = c(0,0), breaks=seq(0, 50, by = 20))


trawl_length2 = trawl_length[, c(6,16:ncol(trawl_length))]
colnames(trawl_length2)
summary(trawl_length2)
trawl_length2 = trawl_length2 %>% tidyr::gather(key = temp, value = extention_number, 2:ncol(trawl_length2)) 
trawl_length2 = trawl_length2 %>% mutate(size_class = as.numeric(str_sub(trawl_length2$temp, 3, 4))) %>% filter(size_class < 32)
summary(trawl_length2)
colnames(trawl_length2)[1] = "NS"
trawl_length2$NS2 = ifelse(trawl_length2$NS == "N", "北部", "南部")
levels(trawl_length2$NS2)
trawl_length2$NS2 = factor(trawl_length2$NS2, levels = c("北部", "南部"))
trawl_length2 = trawl_length2 %>% dplyr::group_by(size_class, NS2) %>% dplyr::summarize(total = sum(extention_number))
summary(trawl_length2)
g = ggplot(trawl_length2, aes(x = size_class, y = total/1000, fill = NS2))
b = geom_bar(stat = "identity", width = 0.8, colour = "black", position = "dodge")
lab = labs(x = "体長（cm）", y = "資源尾数 (千尾)", title = "(C)")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.5), colour = "black"),
           axis.text.y = element_text(size = rel(1.5), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(1.5)),
           strip.text.x = element_text(size = rel(1.5)),
           plot.title = element_text(size = rel(1.5)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
c = scale_fill_manual(values =  c("black", "white"))
fig_a31c = g+b+lab+c+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(0, max(trawl_length2$size_class), by = 2), expand = c(0, 0.5))+scale_y_continuous(expand = c(0,0),limits = c(0, (max(trawl_length2$total/1000))+2))
```




```{r figA3-2, echo=F, warning=F, message=F, results=F, include=F}
# ~2018までのデータ
old_fig32 = read.csv(paste0(dir, "survey_N_at_age.csv"))
old_fig32 = old_fig32 %>% gather(key = l, value = number, 3:ncol(old_fig32))
old_fig32 = old_fig32 %>% mutate(size_class = as.numeric(str_sub(old_fig32$l, 2, 4))) %>% select(-l)

# 2018~のデータ
new_fig32 = number_at_age_table %>% gather(key = size_class, value = number, 2:(ncol(number_at_age_table)-1)) %>% filter(age != "total") %>% mutate(Age = ifelse(age == 10, "10+", age)) %>% select(-age) %>% rename(Year = year) %>% filter(Age != 0)

# 統合
all_fig32 = rbind(old_fig32, new_fig32)

# figure
levels(all_fig32$Age)
unique(all_fig32$Age)
all_fig32$age = factor(all_fig32$Age, levels = c("1", "2", "3", "4", "5", "5+", "6", "7", "8", "9", "10+"))
mode(all_fig32$size_class)
summary(all_fig32)
all_fig32$size_class = as.numeric(all_fig32$size_class)

g = ggplot(all_fig32, aes(x = size_class, y = number/1000000, fill = age))
b = geom_bar(stat = "identity", width = 0.8, colour = "black", size = 0.5)
lab = labs(x = "体長 (cm)", y = "資源尾数 (百万尾)", fill = "年齢")
col_catch = c("red1", "red1", "darkorange", "goldenrod1", "goldenrod4", "grey60", "palegreen3", "palegreen4", "steelblue3", "steelblue4", "grey60")
c = scale_fill_manual(values = col_catch)
f = facet_wrap(~ Year, ncol = 4)
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.5), colour = "black"),
           axis.text.y = element_text(size = rel(1.5), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           legend.text = element_text(size = rel(1.5)),
           strip.text.x = element_text(size = rel(1.5)))
fig_a32 = g+b+lab+c+f+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(expand = c(0,0), breaks=seq(0, 36, by = 5))+scale_y_continuous(expand = c(0,0))
```




```{r figA3-4, echo=F, warning=F, message=F, results=F, include=F}
surv_fig = survival1 %>% filter(age == 2)
surv_fig = surv_fig %>% mutate(temp = as.numeric(str_sub(surv_fig$year, 3, 4))-1) %>% mutate(temp2 = temp+1) 
surv_fig = surv_fig %>% mutate(temp3 = ifelse(surv_fig$temp == -1, "99", ifelse(surv_fig$temp < 10, formatC(surv_fig$temp, width = 2, flag = "0"), surv_fig$temp))) %>% mutate(temp4 = ifelse(temp2 < 10, formatC(surv_fig$temp2, width = 2, flag = "0"), ifelse(temp2 == 100, "00", temp2))) %>% mutate(xtitle = paste0(temp3, "→", temp4)) %>% select(surv, xtitle, year)
# surv_fig$
#   unique(surv_fig$xtitle)
g = ggplot(surv_fig, aes(x = year, y = surv))
p = geom_point(size = 5)
l = geom_line(size = 1)
pa = geom_path()
lab = labs(x = "当年", y = "前年1歳魚尾数に対する当年2歳魚尾数の比率")
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.5)),
           axis.title.y = element_text(size = rel(1.5)),
           legend.title = element_blank(),
           strip.text.x = element_text(size = rel(1.8)),
           legend.position = c(0.1, 0.8),
           legend.background = element_rect(fill = "white", size = 0.4, linetype = "solid", colour = "black"))
fig_a34 = g+p+pa+lab+theme_bw(base_family = "HiraKakuPro-W3")+th+scale_x_continuous(breaks=seq(1996, 2020, by = 2), expand = c(0.03, 0.03))+scale_y_continuous(expand = c(0,0),limits = c(0, 12))
```




```{r fig4, echo=F, warning=F, message=F, results=F, include=F}
# 3-1 図4: 漁場の空間分布 --------------------------------------------------------------
x <- read.delim(paste0(dir, "Map.txt"), header=T)

# 地図ファイル
z <- read.table(paste0(dir, "キアンコウ緯度経度.txt"), header=T, fileEncoding = fileEncoding)
n_sheet = (n_year-2019)-1
z2 = read.xlsx(paste0(dir, "okisoko_after2019.xlsx"), sheet = sheets[n_sheet])
head(z2)
head(z)
for(i in 1 : nrow(z2)) {
  z2[i, 10] <- as.numeric(z[which(z2[i, 4]==z[, 2]), 5])
  z2[i, 11] <- as.numeric(z[which(z2[i, 4]==z[, 2]), 6])
}
y <- z2 
colnames(y) <- c(colnames(y)[1:9], "緯度", "経度")
y[, 12] <- as.numeric(as.character(paste(as.numeric(as.character(substr(y$緯度, 1, 2)))+as.numeric(as.character(substr(y$緯度, 4, 5)))/60)))
y[, 13] <- as.numeric(as.character(paste(as.numeric(as.character(substr(y$経度, 1, 3)))+as.numeric(as.character(substr(y$経度, 5, 6)))/60)))
y <- data.frame(AREA = tapply(y$漁区, y$漁区, mean), 
                LAT = tapply(y[, 12], y$漁区, mean), 
                LONG = tapply(y[, 13], y$漁区, mean), 
                catch = tapply(y$漁獲量の合計, y$漁区, sum))
quartzFonts(HiraKaku = quartzFont(rep("HiraginoSans-W3", 4)))
# theme_set(theme_cowplot(font_family = "HiraKaku")) 
map = ggplot() + coord_fixed() + xlab("Longitude") + ylab("Latitude")
world_map = map_data("world")
region2 = subset(world_map, world_map$region == "Japan")
local_map = map + geom_polygon(data = region2, aes(x = long, y = lat, group = group), colour = "black", fill = "white") + coord_map(xlim = c(140.5, 145.5), ylim = c(35, 43))
th = theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(size = rel(1.8), colour = "black"),
           axis.text.y = element_text(size = rel(1.8), colour = "black"),
           axis.title.x = element_text(size = rel(1.8)),
           axis.title.y = element_text(size = rel(1.8)),
           strip.text.x = element_text(size = rel(1.8)),
           plot.title = element_text(size = rel(1.8)),
           legend.title = element_text(size = rel(1.8)),
           legend.text = element_text(size = rel(1.8)))
p = geom_point(data = y, aes(x = LONG, y = LAT, colour = catch/1000), shape = 15, size = 4)
c = scale_colour_gradientn(colours = c("black", "blue", "cyan", "green", "yellow", "orange", "red", "darkred"))
labs = labs(x = "経度", y = "緯度", colour = "漁獲量（トン）")
fig4 = local_map+theme_bw(base_family = "HiraKakuPro-W3")+th+p+c+labs+
  geom_hline(yintercept = 40.5, colour="black", linetype = "dashed")+
  geom_hline(yintercept = 39, colour="black", linetype = "dashed")+
  geom_hline(yintercept = 38, colour="black", linetype = "dashed")+
  geom_hline(yintercept = 36.5, colour="black", linetype = "dashed")+
  annotate("text",label="尻屋崎", x=144.5, y=41, family="HiraKaku", size = 6)+
  annotate("text",label="岩手", x=144.3, y=39.5, family="HiraKaku", size = 6)+
  annotate("text",label="金華山", x=144.4, y=38.5, family="HiraKaku", size = 6)+
  annotate("text",label="常磐", x=144.3, y=37, family="HiraKaku", size = 6)+
  annotate("text",label="房総", x=144.3, y=36, family="HiraKaku", size = 6)
```







```{r save, echo=F, warning=F, message=F, results=F, include=F}
dir.create(paste0(dir, "output"))
dir_output = paste0(dir, "output")
setwd(dir_output)

# write.csv(catch_new, "catch2021.csv", fileEncoding = fileEncoding, row.names=F) #来年の資源評価で使うデータ
write.csv(catch, "rawdata_fig5_for_nextSA.csv", fileEncoding = fileEncoding, row.names=F) #来年の資源評価で使うデータ
write.csv(table1, "table1.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(table2, "table2.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(effort_t1, "table3.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(table4, "table4.csv", fileEncoding = fileEncoding, row.names=F)
# write.csv(ss_catch, "okisokoCatch_for_SS.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(ss_cpue, "okisokoCPUE_for_SS.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(trend, "estimatedtrend_for_SS.csv", fileEncoding = fileEncoding, row.names=F)

write.csv(trawl %>% mutate(number = number/1000), "tableA4-1.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(tableA4_2, "tableA4-2.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(tableA4_3, "tableA4-3.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(q, "tableA4-4.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(abund_oct_sel %>% mutate(number_sel_thou = number_sel/1000) %>% dplyr::rename(biomass_sel_ton = biomass_sel) %>% select(-number_sel), "tableA4-5&6.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(est %>% mutate(number = number/1000) %>% dplyr::rename(number_thou = number, biomass_ton = biomass), "tableA4-7&8.csv", fileEncoding = fileEncoding, row.names=F) 
write.csv(biomass_female %>% mutate(biomass_ton = biomass/1000000) %>% dplyr::rename(year = year2) %>% select(-biomass), "tableA4-8female.csv", fileEncoding = fileEncoding, row.names=F)
write.csv(fishing_trend, "tableA4-9.csv", fileEncoding = fileEncoding, row.names=F)

ggsave(file = "fig4.png", plot = fig4, units = "in", width = 8.27, height = 11.69)  
ggsave(file = "fig5.png", plot = fig5, dpi = 400, unit = "cm", width = 11.49, height = 6.88)
ggsave(file = "fig6.png", plot = fig6, dpi = 400, unit = "cm", width = 11.49, height = 6.88)
ggsave(file = "fig8.png", plot = grid.arrange(kake, niso, tra, w, ncol = 1), units = "in", width = 9.5, height = 11.69)
ggsave(file = "fig9.png", plot = fig9, units = "in", width = 11.69, height = 8.27)
ggsave(file = "fig10.png", plot = fig10, dpi = 400, unit = "cm", width = 11.49, height = 6.88)
ggsave(file = "fig11.png", plot = fig11, units = "in", width = 11.69, height = 8.27)
ggsave(file = "fig12.png", plot = grid.arrange(trend_f, trend_catch_rate, ncol = 1), units = "in", width = 11.69, height = 8.27)
ggsave(file = "fig13.png", plot = fig13, units = "in", width = 11.69, height = 8.27)
ggsave(file = "fig14.png", plot = grid.arrange(ko, oya, ncol = 1), units = "in", width = 11.69, height = 8.27)
ggsave(file = "fig15.png", plot = fig15, dpi = 400, unit = "cm", width = 11.49, height = 6.88)

layout1 <- rbind(c(1, 2),
                 c(1, 3))
ggsave(file = "figA3-1.png", plot = grid.arrange(fig_a31a, fig_a31b, fig_a31c, layout_matrix = layout1), units = "in", width = 11.69, height = 8.27)
# 
ggsave(file = "figA3-2.png", plot = fig_a32, units = "in", width = 8.27, height = 11.69)
ggsave(file = "figA3-3.png", plot = fig_a33, units = "in", width = 11.69, height = 8.27)
ggsave(file = "figA3-4.png", plot = fig_a34, units = "in", width = 11.69, height = 8.27, scale = 0.9)

# png("ALK.png")
# plotFit(fit, interval = "prediction", ylim = c(0, 250), pch = 19, col.pred = 'light blue', shade=T)
# dev.off()
```






# 要約
#### 今年の資源量（表の上の文章）
`r trend %>% filter(year == n_year)`

#### 表
```{r table_s1_summary, echo=F}
table_s1
```

#### F current（表の下の文章）
`r f_current`

#### 2ページ目の表
```{r table_s2, echo=F}
table_s2
```


  
## 3.漁業の状況
### (2)漁獲量の推移
#### 昨年の全漁業種類を合わせた漁獲量（1段落目）
```{r trend of pref. fisheries catch, echo=F}
# total_catch_pref[1,1]
catchF %>% filter(year == (n_year-1)) %>% select(year, catch) %>% dplyr::rename(catch_ton = catch)
```

#### 昨年の沖底の漁獲量（2段落目）
```{r trend of okisoko, echo=F}
okisoko_1yr %>% select(catch_t)
```

### (3) 漁獲努力量の推移
#### 昨年の有漁網数（暫定値）
```{r trend of effort, echo=F}
effort_t2
```


## 4.資源の状態
### (4) 資源量と漁獲割合の推移
#### 推定資源量（1段落目）
```{r table_biomass, echo=F}
trend %>% dplyr::rename(ton = total)
# %>% filter(year == n_year)
# trend %>% filter(year < 2011) %>% spread(key = year, value = total)
# trend %>% filter(year > 2010) %>% spread(key = year, value = total)
```

#### 資源尾数（2段落目）
```{r table_N, echo=F, message=F}
N_trend %>% dplyr::rename(N_thou = number, age = age2)

```

#### F値（3段落目）
```{r table_fishing trend1, echo=F}
fishing_trend %>% filter(data == "F") %>% select(-data, -data2) %>% dplyr::rename("F" = value)
# %>% filter(year == (n_year-1))
# fishing_trend %>% filter(year < 2011, data == "f") %>% spread(key = year, value = value)
# fishing_trend %>% filter(year > 2010, data == "f") %>% spread(key = year, value = value)
# fishing_trend %>% filter(year < 2011, data == "rate") %>% spread(key = year, value = value)
# fishing_trend %>% filter(year > 2010, data == "rate") %>% spread(key = year, value = value)
```

#### 漁獲割合（3段落目）
```{r table_fishing trend2, echo=F}
fishing_trend %>% filter(data == "rate") %>% select(-data, -data2) %>% dplyr::rename("%" = value)
# %>% filter(year == (n_year-1))
# fishing_trend %>% filter(year < 2011, data == "f") %>% spread(key = year, value = value)
# fishing_trend %>% filter(year > 2010, data == "f") %>% spread(key = year, value = value)
# fishing_trend %>% filter(year < 2011, data == "rate") %>% spread(key = year, value = value)
# fishing_trend %>% filter(year > 2010, data == "rate") %>% spread(key = year, value = value)
```

### (5) 再生産関係
```{r rps, echo=F}
srr %>% select(year2, rps) %>% dplyr::rename(year = year2) %>% filter(year == (n_year-3))
```

### (7) 資源の水準・動向
```{r level and trend of biomass}
# 最小値
trend %>% filter(total == min(trend$total))

# 最大値
trend %>% filter(total == max(trend$total))

# 低中位
(max(trend$total)-min(trend$total))*1/3+min(trend$total)

# 中高位
max(trend$total)-(max(trend$total)-min(trend$total))*1/3
```


### (9) 生物学的管理基準（漁獲係数）と現状の漁獲圧の関係
```{r f_current}
f_current
```

-----
## 2023年ABC算定
### (2) ABCの算定
#### 2022年の年間生残率（1段落目）
```{r survival rate}
s_current
```

#### 1歳魚が翌年の2歳魚になる比率の直近3年間の平均値（2段落目）
```{r survival rate at age 1}
s1_current
```

#### 来年の資源量と資源尾数（3段落目）
```{r stock 2023}
#資源量
(total_biomass_next = sum(abund_abc$next_year_biomass))

#尾数
(total_number_next = sum(abund_abc$next_year_number))
```

#### 今年の資源量と資源尾数（3段落目）
```{r stock 2022, message=F}
#資源量
(trend %>% dplyr::rename(ton = total) %>% filter(year == (n_year)))

#尾数
(est2 %>% dplyr::group_by(year) %>% dplyr::summarize(N_thou = sum(total)/1000) %>% filter(year == (n_year)))
```

#### 来年のABC（4段落目と表）
```{r table_s1, echo=F}
table_s1
```

### (4) ABCの再評価（表）
<!----
`r (n_year - 1)`年の資源量は`r (total_biomass_this = sum(abund_abc$biomass_est))`，F limitは`r (total_biomass_this = sum(abund_abc$biomass_est))`，F targetは`r (re_abc_target = (f_target*(1-exp(-z_abc)))/z_abc*total_biomass_this)`．  
漁獲量とFは要約にある．  
--->
#### 2021（3行目）
```{r reABC 2 years ago}
# 資源量 (2021)
(total_biomass_last = sum(est %>% filter(year == (n_year-1)) %>% select(biomass)))

# limit (2021)
(re_abc_limit_last = (f_limit*(1-exp(-z_abc)))/z_abc*total_biomass_last)

# target (2021)
(re_abc_target_last = (f_target*(1-exp(-z_abc)))/z_abc*total_biomass_last)

# 漁獲量とFは要約にある
```

#### 2022（5行目）
```{r reABC last year}
# 資源量 (2022)
(total_biomass_this = sum(abund_abc$biomass_est))

# limit (2022)
(re_abc_limit = (f_limit*(1-exp(-z_abc)))/z_abc*total_biomass_this)

# target (2022)
(re_abc_target = (f_target*(1-exp(-z_abc)))/z_abc*total_biomass_this)

```
